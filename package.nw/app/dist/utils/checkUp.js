"use strict";function init(){function e(e){y.notifications({title:"有新版本",message:"新版本 "+e+" 已经准备好，立刻重启更新？",buttons:[{title:"重启"}]},function(e){if(0===e){try{m.unRegisterCommon(),m.unRegisterEdit()}catch(e){}chrome.runtime.reload()}})}function r(e){function r(){y.notifications({title:"有新版本",message:"新版本 "+e+" 已经准备好，立刻重启安装？",buttons:[{title:"安装新版本"}]},function(e){if(0===e){var r=q?"open":c,n=q?[c]:[];try{g(r,n,{detached:!0,cwd:I})}catch(e){var t=require("path");nw.Shell.openItem(t.join(I,c))}nw.App.quit()}})}var n=q?"darwin":"x64"===process.arch?"x64":"ia32",t=S+"&type="+n,i={url:t},o=v.getProxyForURL(t);"DIRECT"!==o&&(i.proxy="http://"+o.replace("PROXY ",""));var s=n+"_"+e+"."+(q?"ndmg":"nexe"),a=u.join(I,s),c=n+"_"+e+"."+(q?"dmg":"exe"),p=u.join(I,c);l.existsSync(p)?r():_(i,function(e,n,t){e||l.rename(a,p,function(e){e||r()})}).pipe(l.createWriteStream(a,{mode:511}))}function n(n,t){function i(e){var r={url:S+"&type="+t,needToken:0,encoding:null};c.info("checkUp.js begin fetch new version "+r.url),a(r,function(r,n,t){e(r,t)})}function s(e,r){d.gunzip(e,function(e,n){r(e,n)})}function g(e,r){l.writeFile(m,e,function(e){r(e,m)})}function v(e,r){var t=u.join(I,n.toString());f.sync(t);var i=q?u.join(t,"app.nw"):u.join(t,"package.nw");p.extractAll(e,i);var o=u.join(i,"package.json"),s=JSON.parse(l.readFileSync(o,"utf8"));q?(s.window.frame=!0,s["chromium-args"]="-ignore-certificate-errors -load-extension=/Applications/wechatwebdevtools.app/Contents/Resources/app.nw/app/dist/extensions/"):s["chromium-args"]="-ignore-certificate-errors -load-extension=./package.nw/app/dist/extensions/",l.writeFileSync(o,JSON.stringify(s),"utf8"),localStorage.setItem(A,n),r(null,n)}if(clearInterval(o),"app"===t||"big_code"===t)return void r(n);var m=u.join(I,""+t+n);if(l.existsSync(m))return c.info("checkUp.js "+m+" is existsSync"),localStorage.setItem(A,n),void e(n);var j=[];j.push(i),j.push(s),j.push(g),j.push(v),h.waterfall(j,function(r,n){return r?void c.error("checkUp.js async.waterfall "+r.toString()):void e(n)})}function t(e){var r=e.split("."),n=parseInt(r[0]),t=parseInt(r[1]),i=parseInt(r[2]);return n>b?"app":t>O?"big_code":i>U&&"small_code"}function i(e){var r=t(e.last_ide);r?(c.info("checkUp.js find new version "+e.last_ide+" and current version is "+C),n(e.last_ide,r)):(o&&clearInterval(o),o=setInterval(function(){var e={method:"post",url:w.LOADCONFIG_URL+"?type=checkup",needToken:0,body:JSON.stringify({type:7,version:nw.App.manifest.version})};a(e,function(e,r,n){if(e)c.info("checkUp.js onLineCheck error: "+e.toString());else{var t=JSON.parse(n),o=t.client_list,s={};o.forEach(function(e){s[e.key]=e.value}),i(s);var a=s.scene;if(a)try{a=JSON.parse(a),configStores.setSceneConfig(a)}catch(e){}}}),chrome.processes.getProcessInfo([],!0,function(e){var r=0;for(var n in e){var t=e[n];t.privateMemory&&(r+=t.privateMemory)}var i=j.getRestartInfo(),o=j.getCurrentProject();k("memory_monitor",o.appid,parseInt(r/1024/1024)+","+i.projectRestartNum)})},s))}var o,s=6e5,a=require("../common/request/request.js"),c=require("../common/log/log.js"),p=require("asar"),u=require("path"),l=require("fs"),f=require("mkdir-p"),d=require("zlib"),g=(require("rmdir"),require("child_process").spawn),v=require("./tools.js"),m=require("../common/shortCut/shortCut.js"),h=(d.createGunzip(),require("async")),j=require("../stores/projectStores.js"),w=require("../config/urlConfig.js"),y=(require("../weapp/utils/vendorManager.js"),require("./notifyManager.js")),q="darwin"===process.platform,S=w.downloadRedirectURL+(q?"?os=darwin":"?os=win"),x=(global.appVersion,nw.App.getDataPath(),w.LOADCONFIG_URL,require("../config/dirConfig.js")),I=x.WeappApplication,_=(u.join(I,"uplog.json"),require("request")),k=require("./newReport.js"),C=global.appVersion,R=C.split("."),b=parseInt(R[0]),O=parseInt(R[1]),U=parseInt(R[2]),A="new-version";_exports=function(e){global.appConfig.isDev||i(e)}}var _exports;init(),module.exports=_exports;