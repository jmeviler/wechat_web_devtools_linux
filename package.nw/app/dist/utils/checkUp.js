"use strict";function init(){function e(e){y.notifications({title:"有新版本",message:"新版本 "+e+" 已经准备好，立刻重启更新？",buttons:[{title:"重启"}]},function(e){0===e&&(m.unRegister(),chrome.runtime.reload())})}function r(e){function r(){y.notifications({title:"有新版本",message:"新版本 "+e+" 已经准备好，立刻重启安装？",buttons:[{title:"安装新版本"}]},function(e){if(0===e){var r=x?"open":c,n=x?[c]:[];try{g(r,n,{detached:!0,cwd:_})}catch(e){var i=require("path");nw.Shell.openItem(i.join(_,c))}nw.App.quit()}})}var n=x?"darwin":"x64"===process.arch?"x64":"ia32",i=I+"&type="+n,t={url:i},o=v.getProxyForURL(i);"DIRECT"!==o&&(t.proxy="http://"+o.replace("PROXY ",""));var s=n+"_"+e+"."+(x?"ndmg":"nexe"),a=u.join(_,s),c=n+"_"+e+"."+(x?"dmg":"exe"),p=u.join(_,c);l.existsSync(p)?r():k(t,function(e,n,i){e||l.rename(a,p,function(e){e||r()})}).pipe(l.createWriteStream(a,{mode:511}))}function n(n,i){function t(e){var r={url:I+"&type="+i,needToken:0,encoding:null};c.info("checkUp.js begin fetch new version "+r.url),a(r,function(r,n,i){e(r,i)})}function s(e,r){d.gunzip(e,function(e,n){r(e,n)})}function g(e,r){l.writeFile(m,e,function(e){r(e,m)})}function v(e,r){var i=u.join(_,n.toString());f.sync(i);var t=x?u.join(i,"app.nw"):u.join(i,"package.nw");p.extractAll(e,t);var o=u.join(t,"package.json"),s=JSON.parse(l.readFileSync(o,"utf8"));x?(s.window.frame=!0,s["chromium-args"]="-ignore-certificate-errors -load-extension=/Applications/wechatwebdevtools.app/Contents/Resources/app.nw/app/dist/extensions/"):s["chromium-args"]="-ignore-certificate-errors -load-extension=./package.nw/app/dist/extensions/",l.writeFileSync(o,JSON.stringify(s),"utf8"),localStorage.setItem(L,n),r(null,n)}if(clearInterval(o),"app"===i||"big_code"===i)return void r(n);var m=u.join(_,""+i+n);if(l.existsSync(m))return c.info("checkUp.js "+m+" is existsSync"),localStorage.setItem(L,n),void e(n);var j=[];j.push(t),j.push(s),j.push(g),j.push(v),h.waterfall(j,function(r,n){return r?void c.error("checkUp.js async.waterfall "+r.toString()):void e(n)})}function i(e){var r=e.split("."),n=parseInt(r[0]),i=parseInt(r[1]),t=parseInt(r[2]);return n>O?"app":i>U?"big_code":t>A&&"small_code"}function t(e){var r=i(e.last_ide);r?(c.info("checkUp.js find new version "+e.last_ide+" and current version is "+b),n(e.last_ide,r)):(o&&clearInterval(o),o=setInterval(function(){var e={method:"post",url:w.LOADCONFIG_URL+"?type=checkup",needToken:0,body:JSON.stringify({type:7,version:nw.App.manifest.version})};a(e,function(e,r,n){if(e)c.info("checkUp.js onLineCheck error: "+e.toString());else{var i=JSON.parse(n),o=i.client_list,s={};o.forEach(function(e){s[e.key]=e.value}),t(s),q.check(s);var a=i.notice_list;a&&a.length>0&&y.handleNotificationList(a)}}),chrome.processes.getProcessInfo([],!0,function(e){var r=0;for(var n in e){var i=e[n];i.privateMemory&&(r+=i.privateMemory)}var t=j.getRestartInfo(),o=j.getCurrentProject();R("memory_monitor",o.appid,parseInt(r/1024/1024)+","+t.projectRestartNum)})},s))}var o,s=6e5,a=require("../common/request/request.js"),c=require("../common/log/log.js"),p=require("asar"),u=require("path"),l=require("fs"),f=require("mkdir-p"),d=require("zlib"),g=(require("rmdir"),require("child_process").spawn),v=require("./tools.js"),m=require("../common/shortCut/shortCut.js"),h=(d.createGunzip(),require("async")),j=require("../stores/projectStores.js"),w=require("../config/urlConfig.js"),q=require("../weapp/utils/vendorManager.js"),y=require("./notifyManager.js"),x="darwin"===process.platform,I=w.downloadRedirectURL+(x?"?os=darwin":"?os=win"),S=(global.appVersion,nw.App.getDataPath(),w.LOADCONFIG_URL,require("../config/dirConfig.js")),_=S.WeappApplication,k=(u.join(_,"uplog.json"),require("request")),R=require("./newReport.js"),b=global.appVersion,C=b.split("."),O=parseInt(C[0]),U=parseInt(C[1]),A=parseInt(C[2]),L="new-version";_exports=function(e){global.appConfig.isDev||(t(e),q.check(e))}}var _exports;init(),module.exports=_exports;