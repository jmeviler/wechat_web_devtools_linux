"use strict";function init(){var e=(require("os"),require("path")),t=(require("http"),require("../common/request/request.js")),n=require("fs"),r=require("../stores/windowStores.js"),i=require("../config/dirConfig.js"),a=(require("url"),require("crypto")),o=(nw.App,i.WeappFileCache),c="tmp",u="store",s="wxfile://",l=function(t){var i=void 0,u=r.getUserInfo(),s=u?u.openid:"unknow";do{var l=a.createHash("md5");l.update(""+t+s+Date.now()+Math.random()),i=c+"_"+t+s+l.digest("hex")}while(n.existsSync(e.join(o,i)));return i};_exports={createNewLocalId:function(e){return s+l(e.hash)},isAppTmpPath:function(e){return 0===e.indexOf(s)},getRealPath:function(t){if(this.isAppTmpPath(t)){var n=t.replace(s,"");return e.join(o,n)}return t},copyFileDataToTemp:function(t,r,i){var a=l(r);return n.writeFileSync(e.join(o,""+a+i),t),""+s+a+i},copyFileToTemp:function(e,t,r){if(n.existsSync(e)){var i=n.readFileSync(e);return this.copyFileDataToTemp(i,t,r)}return!1},saveFileForever:function(e){var t=this.getRealPath(e);if(n.existsSync(t)){var r=e.replace(c,u);return n.renameSync(t,this.getRealPath(r)),r}return!1},uploadFileToServer:function(e){var r=e.url,i=e.filePath,a=e.name,o=e.header,c=e.formData,u=e.tlsVersionCheck,s={};u&&(s.secureProtocol="TLSv1_2_method"),o=o||{},c=c||{},c[a]=n.createReadStream(this.getRealPath(i)),t({url:r,agentOptions:s,method:"post",needToken:-1,headers:o,formData:c},function(t,n,r){e.callback&&e.callback(t,n,r)})},downloadFileFormServer:function(e){var n=e.url,r=e.header,i=e.tlsVersionCheck;r=r||{};var a={};i&&(a.secureProtocol="TLSv1_2_method"),t({url:n,agentOptions:a,method:"get",encoding:null,needToken:-1,headers:r},function(t,n,r){e.callback&&e.callback(t,n,r)})},getSavedFileList:function(t){var i=t.hash,a=r.getUserInfo(),c=a?a.openid:"unknow",l=n.readdirSync(o).filter(function(e){return!!~e.indexOf(u+"_"+i+c)}),f=0,h=l.reduce(function(t,r){var i=n.statSync(e.join(o,r));return f=i.size+f,t.push({filePath:""+s+r,size:i.size,createTime:parseInt(i.ctime.getTime()/1e3)}),t},[]);return{fileList:h,totalSize:f}},getFileStat:function(e){var t=this.getRealPath(e),r=void 0;return n.existsSync(t)&&(r=n.statSync(t)),r},removeSavedFile:function(e){var t=this.getRealPath(e),r=!1;return n.existsSync(t)&&(n.unlinkSync(t),r=!0),r},saveBase64DataToFile:function(t,r,i){var a=t.hash,c=new Buffer(r,"base64").toString("binary"),u=l(a);return n.writeFileSync(e.join(o,""+u+i),c,"binary"),""+s+u+i},cleanProjectFile:function(t,r){var i=t.hash,a=n.readdirSync(o).filter(function(e){return!!~e.indexOf(r?"_"+i:c+"_"+i)});a.map(function(t){n.unlinkSync(e.join(o,t))})},cleanTempFile:function(){try{n.readdirSync(o).map(function(t){t.indexOf(c)>=0&&n.unlinkSync(e.join(o,item))})}catch(e){}}}}var _exports;init(),module.exports=_exports;