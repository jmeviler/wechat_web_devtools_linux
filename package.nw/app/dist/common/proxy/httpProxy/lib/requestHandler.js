"use strict";function userRequestHandler(e,t){function r(t){var r=[];e.on("data",function(e){r.push(e)}),e.on("end",function(){a=Buffer.concat(r),o.reqBody=a.toString(),t()})}function n(t){userRule.shouldUseLocalResponse(e,a)?u(t):s(t)}function u(r){userRule.dealLocalResponse(e,a,function(e,n,u){o.endTime=(new Date).getTime(),o.res={statusCode:e||"",headers:n||{}},o.resHeader=n||{},o.resBody=u,o.length=u?u.length:0,o.statusCode=e,t.writeHead(e,n),t.end(u),r&&r()})}function s(r){var n;i=userRule.replaceRequestProtocol(e,i)||i,n={hostname:d.hostname||e.headers.host,port:d.port||e.port||(/https/.test(i)?443:80),path:h,method:e.method,headers:e.headers},userRule.replaceRequestOption(e,n,function(){n.rejectUnauthorized=!1,a=userRule.replaceRequestData(e,a)||a,n.headers=util.lower_keys(n.headers),n.headers["proxy-connection"]&&(n.headers.connection=n.headers["proxy-connection"],delete n.headers["proxy-connection"]),n.headers["accept-language"]&&(n.headers["accept-language"]="zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4"),n.headers["content-length"]=a.length;var u=(/https/.test(i)?https:http).request(n,function(n){var u=n.statusCode;u=userRule.replaceResponseStatusCode(e,n,u)||u;var s=userRule.replaceResponseHeader(e,n,n.headers)||n.headers;s=util.lower_keys(s);var a=/gzip/i.test(s["content-encoding"]),l=[];n.on("data",function(e){l.push(e)}),n.on("end",function(){var i;async.series([function(e){i=Buffer.concat(l),a?zlib.gunzip(i,function(t,r){i=r,e()}):e()},function(t){userRule.replaceServerResData?(i=userRule.replaceServerResData(e,n,i)||i,t()):userRule.replaceServerResDataAsync?userRule.replaceServerResDataAsync(e,n,i,function(e){i=e,t()}):t()},function(t){var r=userRule.pauseBeforeSendingResponse(e,n);r?setTimeout(t,r):t()},function(r){userRule.saveAllHttpResponse(e,u,s,i),t.writeHead(u,s),t.end(i),r()},function(e){o.endTime=(new Date).getTime(),o.statusCode=u,o.resHeader=s,o.resBody=a?zlib.gunzipSync(i):i,o.length=i?i.length:0,e()},function(e){userRule.fetchTrafficData&&userRule.fetchTrafficData(p,o),e()}],function(e,t){r&&r()})}),n.on("error",function(e){log.error("error"+e)})});u.on("error",function(r){log.error("err with request :"+r+"  "+e.url),t.end()}),u.end(a)})}var o,a,l=e.headers.host,i=e.connection.encrypted&&!/^http:/.test(e.url)?"https":"http",c="http"===i?e.url:i+"://"+l+e.url,d=url.parse(c),h=d.path,p=-1;o={host:l,method:e.method,path:h,protocol:i,url:i+"://"+l+h,req:e,startTime:(new Date).getTime()},async.series([r,n],function(){})}function setRules(e){e&&(userRule=util.merge(defaultRule,e),"function"==typeof userRule.init&&userRule.init())}var http=require("http"),url=require("url"),zlib=require("zlib"),async=require("async"),Buffer=require("buffer").Buffer,util=require("./util.js"),log=require("../../../log/log.js"),defaultRule=require("./rule_default.js"),userRule=defaultRule;module.exports={userRequestHandler:userRequestHandler,setRules:setRules};