"use strict";function init(){function e(e){var t=document.createElement("input");t.style.display="none",t.setAttribute("type","file"),e.accept&&t.setAttribute("accept",e.accept),e.multiple&&t.setAttribute("multiple","multiple"),global.contentDocumentBody.appendChild(t),t.addEventListener("change",function(a){e.sucCall&&e.sucCall(a),global.contentDocumentBody.removeChild(t)}),t.addEventListener("cancel",function(a){e.cancelCall&&e.cancelCall(a),global.contentDocumentBody.removeChild(t)}),t.click()}function t(e){var t=m.lookup(e);return t.indexOf("video/")>=0}function a(e,t){h.sendASSDK("previewImage",e,t)}function i(a,i){var o=a.args,n=Number.isInteger(o.count)&&o.count<=9&&o.count>=1?o.count:9,r=o.mediaType||["video","image"],u=[],h=!1;r.indexOf("video")>=0&&u.push("video/*"),r.indexOf("image")>=0&&(h=!0,u.push("image/*")),e({accept:u.join(","),multiple:!!h&&n>1,sucCall:function(e){var o=c.getProjectByHash(a.apphash),r=e.target.value.split(";");r=r.slice(0,n);var u="";r.forEach(function(e){!u&&t(e)&&(u=e)});var h=[];if(u){var m=u,d=l.extname(m),g=p.statSync(m),v=s.copyFileToTemp(m,o.hash,d),f=document.createElement("video");f.setAttribute("src",v.replace("wxfile://","http://wxfile.open.weixin.qq.com/")),f.defaultMuted=!0,f.addEventListener("loadedmetadata",function(){f.play();var e=parseFloat(f.duration);e=isNaN(e)?0:e;var t=Math.min(100*e,500);setTimeout(function(){var e=document.createElement("canvas");e.width=f.videoWidth,e.height=f.videoHeight,e.getContext("2d").drawImage(f,0,0,e.width,e.height);var t=e.toDataURL().replace(/^data:image\/(jpg|png);base64,/,""),a=s.saveBase64DataToFile(o,t,".jpg");h.push({size:g.size,duration:f.duration,width:f.videoWidth,height:f.videoHeight,tempFilePath:v,thumbTempFilePath:a}),i({errMsg:"chooseMedia:ok",type:"video",tempFiles:h})},t)})}else r.forEach(function(e){var t=l.extname(e),a=p.statSync(e);h.push({tempFilePath:s.copyFileToTemp(e,o.hash,t),size:a.size})}),i({errMsg:"chooseMedia:ok",type:"image",tempFiles:h})},cancelCall:function(){i({errMsg:"chooseMedia:cancel"})}})}function o(t,a){var i=t.args,o=Number.isInteger(i.count)&&i.count<=9&&i.count>=1?i.count:9;e({accept:"image/*",multiple:o>1,sucCall:function(e){var i=c.getProjectByHash(t.apphash),n=e.target.value.split(";");n=n.slice(0,o);var r=[];n.forEach(function(e){var t=l.extname(e);r.push(s.copyFileToTemp(e,i.hash,t))}),a({errMsg:"chooseImage:ok",tempFilePaths:r})},cancelCall:function(){a({errMsg:"chooseImage:cancel"})}})}function n(t,a){t.args;e({accept:"video/*",sucCall:function(e){var i=c.getProjectByHash(t.apphash),o=e.target.value.split(";"),n=[],r=o[0],u=l.extname(r);n.push(s.copyFileToTemp(r,i.hash,u)),a({errMsg:"chooseVideo:ok",tempFilePath:n[0]})},cancelCall:function(){a({errMsg:"chooseVideo:cancel"})}})}function r(e,t){var a=e.args.src,i=s.isAppTmpPath(a),o=c.getProjectByHash(e.apphash),n=i?s.getRealPath(a):l.join(o.projectpath,a);if(!p.existsSync(n))return void t({errMsg:"getImageInfo:fail file not exist"});var r=p.createReadStream(n);u(r,function(e,a){t(e?{errMsg:"getImageInfo:fail "+e.toString()}:{errMsg:"getImageInfo:ok",width:a.width,height:a.height})})}var c=(require("../../utils/tools.js"),require("../../stores/projectStores.js")),s=require("../../utils/file.js"),l=require("path"),u=(require("url"),require("../../lib/imagesize.js")),p=require("fs"),h=(require("../../common/request/request.js"),require("../../weapp/utils/tools.js"),require("../../actions/webviewActions.js")),m=require("mime-types");_exports={chooseVideo:n,chooseImage:o,previewImage:a,getImageInfo:r,chooseMedia:i}}var _exports;init(),module.exports=_exports;