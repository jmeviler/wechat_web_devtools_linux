"use strict";function init(){function r(r){return 0===Buffer.compare(new Buffer(r.toString(),"utf8"),r)}var e="darwin"===process.platform,i=global.appConfig.isDev,n=require("fs"),o=require("path"),t=require("../utils/tools.js"),s=require("glob"),c=require("async"),a=require("../../config/dirConfig.js"),u=a.WeappVendor,f=require("mkdir-p"),l=require("./initAppConfig.js"),p=require("./initAppServiceJs.js"),d=require("./initExtConfig.js"),v=(require("child_process").spawn,require("../../common/log/log.js")),j=require("babel-core"),g=require("autoprefixer"),m=require("postcss"),w=require("uglify-js"),b=require("csso"),q=i?o.join(__dirname,"../vendor/"):u,y=(e?o.join(q,"wcc"):o.join(q,"wcc.exe"),["iOS >= 8","Chrome >= 37"]),x=a.Weappdest,S={".js":!0,".json":!0,".wxml":!0,".wcss":!0},h=t.whiteFileExtName;_exports=function(e,i,t){var a=(e.projectpath,e.es6),u=e.minified,q=e.postcss,_=!!e.ext_appid,F=o.join(x,""+ +new Date);f.sync(F);var E={};E.appconfig=function(r){l(e,i,function(e,i){r(e,i)})},E.extconfig=function(r){d(e,i,function(e,i){r(e,i)})},E.appservicejs=function(r){p(e,i,function(e,i){r(e,i)})},c.parallel(E,function(i,c){return i?void t(i.toString()):void s("./**",{nodir:!0,cwd:e.projectpath,ignore:["./node_modules/**/*"]},function(i,s){if(i)v.error("build.js error while glob files "+i.toString()),t(i.toString(),F);else{for(var c=0;c<s.length;c++){var l=s[c],p=o.extname(l);if(h[p])if(e.platform&&!_&&"./ext.json"===l)v.info("build.js find ext.json but project.ext_appid is false");else{var d=o.join(F,l),x=o.dirname(d);f.sync(x);var E=void 0;try{E=n.readFileSync(o.join(e.projectpath,l))}catch(r){return void t(r.toString(),F)}if(S[p]&&!r(E))return void t(l+" - 不是 UTF8 编码，请检查后重试");if(".js"===p){var C=E.toString();if(a||u){var A=C;if(a){try{var B=j.transform(C,{presets:["es2015"],babelrc:!1});A=B.code}catch(r){return void t(l+" - "+r)}if(u)try{var D=w.minify("(function(){\n "+A+" \n})()",{fromString:!0});A=D.code}catch(r){return void t(l+" "+r.line+" - "+r.message)}}else try{var W=j.transform(C,{presets:["babili"],babelrc:!1});A=W.code}catch(r){return void t(l+" - "+r)}n.writeFileSync(d,A)}else n.writeFileSync(d,C)}else if(q&&".wxss"===p){var k=E.toString();try{var J=m([g({browsers:y,remove:!1})]).process(k).css;if(u){var L=b.minify(J,{restructure:!1}).css;n.writeFileSync(d,L,"utf8")}else n.writeFileSync(d,J,"utf8")}catch(r){v.error("build.js build css error "+l+" "+r.parseError.line+":"+r.parseError.column+" - "+r.message);var N=l+" "+r.parseError.line+":"+r.parseError.column+" - "+r.message;return void t(N)}}else n.writeFileSync(d,E)}else v.info("build.js find file not in whiteList "+l)}t(null,F)}})})}}var _exports;init(),module.exports=_exports;