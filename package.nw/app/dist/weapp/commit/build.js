"use strict";function init(){function r(r){return 0===Buffer.compare(new Buffer(r.toString(),"utf8"),r)}var e="darwin"===process.platform,i=global.appConfig.isDev,n=require("fs"),o=require("path"),t=require("../utils/tools.js"),s=require("glob"),c=require("async"),a=require("../../config/dirConfig.js"),u=a.WeappVendor,f=require("mkdir-p"),l=require("./initAppConfig.js"),p=require("./initAppServiceJs.js"),d=require("./initExtConfig.js"),v=(require("child_process").spawn,require("../../common/log/log.js")),j=require("babel-core"),g=require("autoprefixer"),m=require("postcss"),b=require("uglify-js"),w=i?o.join(__dirname,"../vendor/"):u,q=(e?o.join(w,"wcc"):o.join(w,"wcc.exe"),["iOS >= 8","Chrome >= 37"]),x=a.Weappdest,h={".js":!0,".json":!0,".wxml":!0,".wcss":!0},y=t.whiteFileExtName;_exports=function(e,i,t){var a=(e.projectpath,e.es6),u=e.minified,w=e.postcss,S=!!e.ext_appid,_=o.join(x,""+ +new Date);f.sync(_);var F={};F.appconfig=function(r){l(e,i,function(e,i){r(e,i)})},F.extconfig=function(r){d(e,i,function(e,i){r(e,i)})},F.appservicejs=function(r){p(e,i,function(e,i){r(e,i)})},c.parallel(F,function(i,c){return i?void t(i.toString()):void s("./**",{nodir:!0,cwd:e.projectpath,ignore:["./node_modules/**/*"]},function(i,s){if(i)v.error("build.js error while glob files "+i.toString()),t(i.toString(),_);else{for(var c=0;c<s.length;c++){var l=s[c],p=o.extname(l);if(y[p])if(e.platform&&!S&&"./ext.json"===l)v.info("build.js find ext.json but project.ext_appid is false");else{var d=o.join(_,l),x=o.dirname(d);f.sync(x);var F=void 0;try{F=n.readFileSync(o.join(e.projectpath,l))}catch(r){return void t(r.toString(),_)}if(h[p]&&!r(F))return void t(l+" - 不是 UTF8 编码，请检查后重试");if(".js"===p){var E=F.toString();if(a||u){var C=E;if(a){try{var A=j.transform(E,{presets:["es2015"],babelrc:!1});C=A.code}catch(r){return void t(l+" - "+r)}if(u)try{var B=b.minify("(function(){\n "+C+" \n})()",{fromString:!0});C=B.code}catch(r){return void t(l+" "+r.line+" - "+r.message)}}else try{var D=j.transform(E,{presets:["babili"],babelrc:!1});C=D.code}catch(r){return void t(l+" - "+r)}n.writeFileSync(d,C)}else n.writeFileSync(d,E)}else if(w&&".wxss"===p){var W=F.toString();try{var k=m([g({browsers:q,remove:!1})]).process(W).css;n.writeFileSync(d,k,"utf8")}catch(r){v.error("build.js build css error "+l+" "+r.parseError.line+":"+r.parseError.column+" - "+r.message);var J=l+" "+r.parseError.line+":"+r.parseError.column+" - "+r.message;return void t(J)}}else n.writeFileSync(d,F)}else v.info("build.js find file not in whiteList "+l)}t(null,_)}})})}}var _exports;init(),module.exports=_exports;