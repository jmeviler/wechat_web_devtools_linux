"use strict";function init(){function e(e){return 0===Buffer.compare(new Buffer(e.toString(),"utf8"),e)}var r="darwin"===process.platform,i=global.appConfig.isDev,n=require("fs"),t=require("path"),o=require("../utils/tools.js"),s=require("glob"),c=require("async"),a=require("../../config/dirConfig.js"),f=a.WeappVendor,u=require("mkdir-p"),l=require("./initAppConfig.js"),p=require("./initAppServiceJs.js"),d=require("./initExtConfig.js"),v=(require("child_process").spawn,require("../../common/log/log.js")),j=require("babel-core"),g=require("autoprefixer"),m=require("postcss"),w=require("uglify-js"),b=i?t.join(__dirname,"../vendor/"):f,q=(r?t.join(b,"wcc"):t.join(b,"wcc.exe"),["iOS >= 8","Chrome >= 37"]),x=a.Weappdest,h={".js":!0,".json":!0,".wxml":!0,".wcss":!0},y=o.whiteFileExtName;_exports=function(r,i,o){var a=(r.projectpath,r.es6),f=r.minified,b=r.postcss,S=!!r.ext_appid,_=t.join(x,""+ +new Date);u.sync(_);var F={};F.appconfig=function(e){l(r,i,function(r,i){e(r,i)})},F.extconfig=function(e){d(r,i,function(r,i){e(r,i)})},F.appservicejs=function(e){p(r,i,function(r,i){e(r,i)})},c.parallel(F,function(i,c){return i?void o(i.toString()):void s("./**",{nodir:!0,cwd:r.projectpath,ignore:["./node_modules/**/*"]},function(i,s){if(i)v.error("build.js error while glob files "+i.toString()),o(i.toString(),_);else{for(var c=0;c<s.length;c++){var l=s[c],p=t.extname(l);if(y[p])if(r.platform&&!S&&"./ext.json"===l)v.info("build.js find ext.json but project.ext_appid is false");else{var d=t.join(_,l),x=t.dirname(d);u.sync(x);var F=void 0;try{F=n.readFileSync(t.join(r.projectpath,l))}catch(e){return void o(e.toString(),_)}if(h[p]&&!e(F))return void o(l+" - 不是 UTF8 编码，请检查后重试");if(".js"===p){var C=F.toString();if(a||f){var A=C;if(a){try{var B=j.transform(C,{presets:["es2015"],babelrc:!1});A=B.code}catch(e){return void o(l+" - "+e)}if(f)try{var D=w.minify("(function(){\n "+A+" \n})()",{fromString:!0});A=D.code}catch(e){return void o(l+":"+e.line+" - "+e.message)}}else try{var E=j.transform(C,{presets:["babili"],babelrc:!1});A=E.code}catch(e){return void o(l+" - "+e)}n.writeFileSync(d,A)}else n.writeFileSync(d,C)}else if(b&&".wxss"===p){var W=F.toString();try{var k=m([g({browsers:q,remove:!1})]).process(W).css;n.writeFileSync(d,k,"utf8")}catch(e){return void o(e)}}else{var J=F;n.writeFileSync(d,J)}}else v.info("build.js find file not in whiteList "+l)}o(null,_)}})})}}var _exports;init(),module.exports=_exports;