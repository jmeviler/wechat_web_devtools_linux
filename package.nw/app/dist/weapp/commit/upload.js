"use strict";function init(){var e=require("fs"),r=require("./pack.js"),o=require("./build.js"),i=require("path"),t=require("../../common/request/request.js"),n=require("../../config/dirConfig.js"),p=require("../../stores/projectStores.js"),u=require("../../weapp/utils/projectManager.js"),a=require("../../config/urlConfig.js"),s=require("rmdir"),d=require("zlib"),c=require("../../common/log/log.js");_exports={};var l=n.Weappdest;_exports.uploadForTest=function(n,f,g){var v=p.getProjectConfig(n),m=void 0;try{m=v.Setting.MaxCodeSize}catch(e){m=1}var q=1024*m,j=!f.isBuildForUpload;o(n,{noCompile:!0},function(o,p){if(o)return void g(o.toString());var v=i.join(l,+new Date+".wx");r(p,v,function(r,o){s(p,function(e,r,o){});var i=e.lstatSync(v),l=parseInt(i.size/1024);if(l>q)return e.unlink(v,function(){}),void g("代码包大小为 "+l+" kb，超出限制 "+(l-q)+" kb，请删除文件后重试");var m=void 0;if(j){m=f.isNewFeature?a.testSourceNewFeatureURL+"?appid="+n.appid+"&gzip=1":a.testSourceURL+"?appid="+n.appid+"&gzip=1";var S=f.page,x=f.query;if(x&&!S)try{var h=u.getAppJSONSync(n);S=h.pages[0]}catch(e){}if(S){var C=encodeURIComponent(S+"?"+x);m=m+"&path="+C}}else{var U=encodeURIComponent(f.desc),_=encodeURIComponent(f.version),y=encodeURIComponent(f.uuid);m=a.commitSourceURL+"?appid="+n.appid+"&user-version="+_+"&user-desc="+U+"&uuid="+y+"&gzip=1"}var z=e.readFileSync(o);c.info("upload.js upload file "+o+" length "+z.length);var F=d.gzipSync(z);c.info("upload.js upload file "+o+" after gzip length "+F.length);var R=u.getExtAppId(n)||"",k="&ext_appid="+R+"&platform="+(n.platform?1:0);t({url:""+m+k,method:"post",body:F,needToken:1},function(r,o,i){g(r,o,i,{MAX_APP_LENGTH:q}),e.unlink(v,function(){})})})})},_exports.upload=function(e,r,o){r.isBuildForUpload=!0,_exports.uploadForTest(e,r,o)}}var _exports;init(),module.exports=_exports;