"use strict";function init(){function e(){E.info("projectManager.js cleanProjects");for(var e in J)J[e].watcher&&J[e].watcher.close();J={}}function t(a){var n=a.hash;if(!J[n]){B.project=a,Object.keys(J).length>L&&e(),E.info("manager.js initProject projectid "+a.projectid);var i={cache:{},wxmlFileList:[],jsFileList:[]};J[n]=i,i.watcher=O.watch(a.projectpath,{ignored:[/node_modules/],ignoreInitial:!0,ignorePermissionErrors:!0,followSymlinks:!0,interval:1e3,binaryInterval:1e3}).on("all",function(e,t,n){var i=S.extname(t);F.whiteFileExtName[i]&&(t=S.relative(a.projectpath,t),r(a,e,t,n))}),i.watcher.on("error",function(r){r&&!q&&(E.error("projectManager.js obj.watcher error "+r.toString()),q=!0,e(),t(a))}),_.setProjectExtAppid(n,d(a))}}function r(e,t,r,i){var o=e.hash,c=J[o].cache;r=r.replace(/\\/g,"/"),"app.json"!==r&&"ext.json"!==r||(J[o].cache={},"ext.json"===r&&_.setProjectExtAppid(o,d(e))),r&&c[r]&&(delete c[r],delete c["app-config.json"]);var s=S.extname(r);".wxml"===s?(clearTimeout(v),J[o].wxmlFileList=[],v=setTimeout(function(){a(e)},20)):".js"===s&&(clearTimeout(b),J[o].jsFileList=[],b=setTimeout(function(){n(e)},20)),B.fileChange(e,t,r,i)}function a(e,t){try{var r=w.sync("./**/*.wxml",{nodir:!0,cwd:e.projectpath,ignore:["node_modules/**/*"],nosort:!0,strict:!1,silent:!0}),a=e.hash;J[a].wxmlFileList=r,t&&t(null,r)}catch(e){E.error("projectManager.js findAllWXMLFiles "+e.toString()),t&&t(e,[])}}function n(e,t){try{var r=w.sync("**/*.js",{nodir:!0,cwd:e.projectpath,ignore:["node_modules/**/*"],nosort:!0,strict:!1,silent:!0}),a=e.hash;J[a].jsFileList=r,t&&t(null,r)}catch(e){E.error("projectManager.js findAllJSFiles "+e.toString()),t&&t(e,[])}}function i(e,r){var a=e.project,n=a.hash;t(a);var i=decodeURIComponent(e.fileName),o=J[n].cache;if(o[i])return void process.nextTick(function(){r(o[i].error,o[i].data)});var c=a.es6,s=e.needRequire,l=S.join(a.projectpath,i);m.readFile(l,"utf8",function(e,t){if(e)return void r({e:e,type:P.PAGEJS_FILE_ERROR,file:i});if(c){var a=S.basename(i);try{var n=R.transform(t,{presets:["es2015"],sourceMaps:"inline",sourceFileName:a,babelrc:!1});t=n.code.replace("sourceMappingURL=data:application/json;","sourceMappingURL=data:application/json;charset=utf-8;")}catch(e){var l=N(t,e.loc.line,e.loc.column>0?e.loc.column:1);return void r({msg:e.toString()+"\n"+l,sourceFileName:a},t)}}t='define("'+i+'", function(require, module, exports, '+A+"){ "+t+"\n});",s&&(t+='require("'+i+'")'),o[i]={error:null,data:t},r(null,t)})}function o(e,r,a){t(e);var n=e.hash,i=J[n].cache;if(i[r])return void process.nextTick(function(){a(i[r].error,i[r].data)});var o=S.join(e.projectpath,r);m.readFile(o,function(e,t){e||(i[r]={error:e,data:t}),a(e,t)})}function c(e,r){t(e);var n=e.hash,i=J[n].wxmlFileList;i.length?process.nextTick(function(){r(null,i)}):a(e,r)}function s(e,r){t(e);var a=e.hash,i=J[a].jsFileList;i.length?process.nextTick(function(){r(null,i)}):n(e,r)}function l(e,r){t(e);var a=e.hash,n=x.parse(r),i=n.pathname.replace(/^\//,""),o=S.extname(i),c=o?i.replace(o,".json"):i+".json",s=J[a].cache;if(s[c])return s[c];var l=e.projectpath,p=u(e),f=h(e)||{},g=S.join(l,c),j=m.existsSync(g),d=f&&f.extEnable&&f.extPages&&f.extPages[r],v={};if(j){var b=m.readFileSync(g,"utf8");try{v=JSON.parse(b)}catch(e){throw{e:e,data:b,type:P.JSON_PARSE_ERROR,file:c}}}return s[c]=Object.assign({},p.window,v,d?f.extPages[r]:{}),s[c]}function p(e){var t=e.hash,r=J[t].cache,a="app-config.json",n=r[a];if(n)return n;n={};var i=u(e)||{};n.pages=i.pages||[],n.entryPagePath=i.pages[0]+".html",n.debug=i.debug||!1,n.networkTimeout=i.networkTimeout||{},n.global={window:i.window||{}},n.customClose=new Boolean(i.customClose),n.ext=i.ext||{},n.extAppid=i.extAppid||"",n.page={};for(var o=i.pages,c=0;c<o.length;c++){var s=o[c],p=l(e,s)||{};n.page[s+".html"]={window:p}}if("[object Object]"==Object.prototype.toString.call(i.tabBar)){for(var h=Object.assign({},i.tabBar),f=[].concat(h.list||[]),g=[],c=0;c<f.length;c++){var j=Object.assign({},f[c]);j.pagePath+=".html",g.push(j)}h.list=g,n.tabBar=h}return r[a]=n,n}function h(e){var t=e.hash,r=J[t].cache,a=e.projectpath,n="ext.json",i=S.join(a,n),o=m.existsSync(i);if(o){var c=r[n];if(c)return c;var s=void 0;try{s=m.readFileSync(i,"utf8")}catch(e){throw{e:e,type:P.JSON_FILE_ERROR,file:n}}try{c=JSON.parse(s)}catch(e){throw{e:e,type:P.JSON_PARSE_ERROR,file:n,data:s}}return r[n]=c,c}return{}}function u(e){t(e);var r=e.hash,a="app.json",n=J[r].cache,i=n[a];if(i)return i;var o=e.projectpath,c=S.join(o,"app.json"),s=void 0;try{s=m.readFileSync(c,"utf8")}catch(e){throw{e:e,type:P.JSON_FILE_ERROR,file:"app.json"}}try{i=JSON.parse(s)}catch(e){throw{e:e,type:P.JSON_PARSE_ERROR,file:"app.json",data:s}}if(e.platform)try{var l=h(e);if(l&&l.extEnable)for(var p in l)"extPages"!==p&&("[object object]"==Object.prototype.toString.call(l[p]).toLowerCase()?i[p]=Object.assign({},i[p]||{},l[p]):i[p]=l[p])}catch(e){throw{e:e,type:P.JSON_PARSE_ERROR,file:"ext.json",data:e.data}}var u=i.pages;if(!u||0===u.length)throw{type:P.JSON_ENTRANCE_ERROR,file:"app.json",data:s};var f=i.tabBar;if(f){var g=[];if("[object Array]"!=Object.prototype.toString.call(f.list))g.push("tabBar.list 应为数组");else if(!f.list||f.list.length<2)g.push("tabBar.list 需至少包含两个项目");else if(f.list.length>5)g.push("tabBar.list 不能超过 5 个配置项");else for(var j=0;j<f.list.length;j++){var d=f.list[j];if("[object Object]"==Object.prototype.toString.call(d)){var v=f.list[j].pagePath;"[object String]"==Object.prototype.toString.call(v)?v.split("?").length>=2?g.push("tabBar.list["+j+"].pagePath 不应该包含'?'"):v.split(".").length>=2&&g.push("tabBar.list["+j+"].pagePath 不应该包含'.'"):g.push("tabBar.list["+j+"].pagePath 需为 String")}else g.push("tabBar.list["+j+"] 需为 Object")}if(g.length>0)throw{type:P.JSON_CONTENT_ERROR,file:"app.json",data:g.join("\n")}}return i.window||(i.window={}),n[a]=i,i}function f(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=F.getBaseURL(e);if(t.justHost)return r;var a=u(e)||{},n=a.pages||[],i=n[0]+".html",o=e.initPath;if(o&&o.enable){var c=o.page||n[0];i=c+".html?"+o.query}return x.resolve(r,i)}function g(e,t){var r=u(e),a=r.pages||[];t=t.replace(/\\/g,"/");var n=a.findIndex(function(e){return e===t});return n!==-1}function j(e,t){for(var r=S.resolve(t),a=u(e),n=a.tabBar||{},i=n.list||[],o=0;o<i.length;o++)if(r===S.resolve(i[o].pagePath))return!0;return!1}function d(e){try{var t=h(e);if(t&&t.extEnable&&t.extAppid)return t.extAppid}catch(e){}return""}var v,b,m=require("fs"),S=require("path"),x=require("url"),y=require("events").EventEmitter,w=require("glob"),O=require("chokidar"),R=require("babel-core"),E=require("../../common/log/log.js"),F=require("./tools.js"),_=require("../../stores/projectStores.js"),P=require("../../config/config.js"),N=require("babel-code-frame"),A=F.noBrowser.join(","),L=1,J={},q=!1;_.on("PROJECT_STORES_CONFIG_CHANGE",function(e){var t=e.hash;E.info("projectManager.js project config change"),J[t]&&(J[t]={cache:{},wxmlFileList:{},jsFileList:{}})});var B=Object.assign({},y.prototype,{fileChange:function(e,t,r,a){this.emit("FILE_CHANGE",e,t,r,a)},stopWatch:function(){e()},restartWatch:function(){t(this.project)}});_exports={manager:B,getFile:o,getAllWXMLFileList:c,getAllJSFileList:s,getScripts:i,getAppJSONSync:u,getExtJSONSync:h,getAppEntranceSync:f,getPageJSONSync:l,getAppConfigJSONSync:p,isProjectPage:g,getExtAppId:d,isTabBar:j}}var _exports;init(),module.exports=_exports;