"use strict";function init(){function e(){N.info("projectManager.js cleanProjects");for(var e in T)T[e].watcher&&T[e].watcher.close();T={}}function t(a){var n=a.hash;if(!T[n]){I.project=a,Object.keys(T).length>B&&e(),N.info("manager.js initProject projectid "+a.projectid);var i={cache:{},wxmlFileList:[],jsFileList:[]};T[n]=i,i.watcher=_.watch(a.projectpath,{ignored:[/node_modules/],ignoreInitial:!0,ignorePermissionErrors:!0,followSymlinks:!0,interval:1e3,binaryInterval:1e3}).on("all",function(e,t,n){var i=O.extname(t);P.whiteFileExtName[i]&&(t=O.relative(a.projectpath,t),r(a,e,t,n))}),i.watcher.on("error",function(r){r&&!C&&(N.error("projectManager.js obj.watcher error "+r.toString()),C=!0,e(),t(a))}),A.setProjectExtAppid(n,d(a))}}function r(e,t,r,i){var o=e.hash,c=T[o].cache;r=r.replace(/\\/g,"/"),"app.json"!==r&&"ext.json"!==r||(T[o].cache={},"ext.json"===r&&A.setProjectExtAppid(o,d(e))),r&&c[r]&&(delete c[r],delete c["app-config.json"]);var s=O.extname(r);".wxml"===s?(clearTimeout(S),T[o].wxmlFileList=[],S=setTimeout(function(){a(e)},20)):".js"===s&&(clearTimeout(y),T[o].jsFileList=[],y=setTimeout(function(){n(e)},20)),I.fileChange(e,t,r,i)}function a(e,t){try{var r=E.sync("./**/*.wxml",{nodir:!0,cwd:e.projectpath,ignore:["node_modules/**/*"],nosort:!0,strict:!1,silent:!0}),a=e.hash;T[a].wxmlFileList=r,t&&t(null,r)}catch(e){N.error("projectManager.js findAllWXMLFiles "+e.toString()),t&&t(e,[])}}function n(e,t){try{var r=E.sync("**/*.js",{nodir:!0,cwd:e.projectpath,ignore:["node_modules/**/*"],nosort:!0,strict:!1,silent:!0}),a=e.hash;T[a].jsFileList=r,t&&t(null,r)}catch(e){N.error("projectManager.js findAllJSFiles "+e.toString()),t&&t(e,[])}}function i(e,t){var r=e.project,a=decodeURIComponent(e.fileName),n=b(r);if(n[a])return void process.nextTick(function(){t(n[a].error,n[a].data)});var i=r.es6,o=e.needRequire,c=O.join(r.projectpath,a);x.readFile(c,"utf8",function(e,r){if(e)return void t({e:e,type:L.PAGEJS_FILE_ERROR,file:a});if(i){var c=O.basename(a);try{var s=F.transform(r,{presets:["es2015"],sourceMaps:"inline",sourceFileName:c,babelrc:!1});r=s.code.replace("sourceMappingURL=data:application/json;","sourceMappingURL=data:application/json;charset=utf-8;")}catch(e){var l="";return e.loc&&(l=J(r,e.loc.line,e.loc.column>0?e.loc.column:1)),void t({msg:e.toString()+"\n"+l,sourceFileName:c},r)}}r='define("'+a+'", function(require, module, exports, '+q+"){ "+r+"\n});",o&&(r+='require("'+a+'")'),n[a]={error:null,data:r},t(null,r)})}function o(e,t,r){var a=b(e);if(a[t])return void process.nextTick(function(){r(a[t].error,a[t].data)});var n=O.join(e.projectpath,t);x.readFile(n,function(e,n){e||(a[t]={error:e,data:n}),r(e,n)})}function c(e,t){var r=(e.hash,v(e)),n=r.wxmlFileList;n.length?process.nextTick(function(){t(null,n)}):a(e,t)}function s(e,t){var r=v(e),a=r.jsFileList;a.length?process.nextTick(function(){t(null,a)}):n(e,t)}function l(e,t){var r=w.parse(t),a=r.pathname.replace(/^\//,""),n=O.extname(a),i=n?a.replace(n,".json"):a+".json",o=b(e);if(o[i])return o[i];var c=e.projectpath,s=f(e),l=u(e)||{},p=O.join(c,i),h=x.existsSync(p),g=l&&l.extEnable&&l.extPages&&l.extPages[t],j={};if(h){var d=x.readFileSync(p,"utf8");try{j=JSON.parse(d)}catch(e){throw{e:e,data:d,type:L.JSON_PARSE_ERROR,file:i}}}return o[i]=Object.assign({},s.window,j,g?l.extPages[t]:{}),o[i]}function p(e){var t=b(e),r="app-config.json",a=t[r];if(a)return a;a={};var n=f(e)||{};a.pages=n.pages||[],a.entryPagePath=n.pages[0]+".html",a.debug=n.debug||!1,a.networkTimeout=n.networkTimeout||{},a.global={window:n.window||{}},a.customClose=new Boolean(n.customClose),a.ext=n.ext||{},a.extAppid=n.extAppid||"",a.page={};for(var i=n.pages,o=0;o<i.length;o++){var c=i[o],s={};try{s=l(e,c)}catch(e){throw{e:e,type:L.JSON_FILE_ERROR,file:c+".json"}}a.page[c+".html"]={window:s}}if("[object Object]"==Object.prototype.toString.call(n.tabBar)){for(var p=Object.assign({},n.tabBar),u=[].concat(p.list||[]),h=[],o=0;o<u.length;o++){var g=Object.assign({},u[o]);g.pagePath+=".html",h.push(g)}p.list=h,a.tabBar=p}return t[r]=a,a}function u(e){var t=b(e),r=e.projectpath,a="ext.json",n=O.join(r,a),i=x.existsSync(n);if(i){var o=t[a];if(o)return o;var c=void 0;try{c=x.readFileSync(n,"utf8")}catch(e){throw{e:e,type:L.JSON_FILE_ERROR,file:a}}try{o=JSON.parse(c)}catch(e){throw{e:e,type:L.JSON_PARSE_ERROR,file:a,data:c}}return t[a]=o,o}return{}}function f(e){var t="app.json",r=b(e),a=r[t];if(a)return a;var n=e.projectpath,i=O.join(n,"app.json"),o=void 0;try{o=x.readFileSync(i,"utf8")}catch(e){throw{e:e,type:L.JSON_FILE_ERROR,file:"app.json"}}try{a=JSON.parse(o)}catch(e){throw{e:e,type:L.JSON_PARSE_ERROR,file:"app.json",data:o}}if(e.platform)try{var c=u(e);if(c&&c.extEnable)for(var s in c)"extPages"!==s&&("[object object]"==Object.prototype.toString.call(c[s]).toLowerCase()?a[s]=Object.assign({},a[s]||{},c[s]):a[s]=c[s])}catch(e){throw{e:e,type:L.JSON_PARSE_ERROR,file:"ext.json",data:e.data}}var l=a.pages;if(!l||0===l.length)throw{type:L.JSON_ENTRANCE_ERROR,file:"app.json",data:o};var p=a.tabBar;if(p){var f=[];if("[object Array]"!=Object.prototype.toString.call(p.list))f.push("tabBar.list 应为数组");else if(!p.list||p.list.length<2)f.push("tabBar.list 需至少包含两个项目");else if(p.list.length>5)f.push("tabBar.list 不能超过 5 个配置项");else for(var h=0;h<p.list.length;h++){var g=p.list[h];if("[object Object]"==Object.prototype.toString.call(g)){var j=p.list[h].pagePath;"[object String]"==Object.prototype.toString.call(j)?j.split("?").length>=2?f.push("tabBar.list["+h+"].pagePath 不应该包含'?'"):j.split(".").length>=2&&f.push("tabBar.list["+h+"].pagePath 不应该包含'.'"):f.push("tabBar.list["+h+"].pagePath 需为 String")}else f.push("tabBar.list["+h+"] 需为 Object")}if(f.length>0)throw{type:L.JSON_CONTENT_ERROR,file:"app.json",data:f.join("\n")}}return a.window||(a.window={}),r[t]=a,a}function h(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=P.getBaseURL(e);if(t.justHost)return r;var a=f(e)||{},n=a.pages||[],i=n[0]+".html",o=e.initPath;if(o&&o.enable){var c=o.page||n[0];i=c+".html?"+o.query}return w.resolve(r,i)}function g(e,t){var r=f(e),a=r.pages||[];t=t.replace(/\\/g,"/");var n=a.findIndex(function(e){return e===t});return n!==-1}function j(e,t){for(var r=O.resolve(t),a=f(e),n=a.tabBar||{},i=n.list||[],o=0;o<i.length;o++)if(r===O.resolve(i[o].pagePath))return!0;return!1}function d(e){try{var t=u(e);if(t&&t.extEnable&&t.extAppid)return t.extAppid}catch(e){}return""}function v(e){var r=e.hash;return T[r]||t(e),T[r]}function b(e){return v(e).cache}function m(e){var r=e.hash,a=T[r];a?(a.cache={},a.wxmlFileList=[],a.jsFileList=[]):t(e)}var S,y,x=require("fs"),O=require("path"),w=require("url"),R=require("events").EventEmitter,E=require("glob"),_=require("chokidar"),F=require("babel-core"),N=require("../../common/log/log.js"),P=require("./tools.js"),A=require("../../stores/projectStores.js"),L=require("../../config/config.js"),J=require("babel-code-frame"),q=P.noBrowser.join(","),B=1,T={},C=!1;A.on("PROJECT_STORES_CONFIG_CHANGE",function(e){N.info("projectManager.js project config change"),m(e)});var I=Object.assign({},R.prototype,{fileChange:function(e,t,r,a){this.emit("FILE_CHANGE",e,t,r,a)},stopWatch:function(){e()},restartWatch:function(){t(this.project)}});_exports={manager:I,getFile:o,getAllWXMLFileList:c,getAllJSFileList:s,getScripts:i,getAppJSONSync:f,getExtJSONSync:u,getAppEntranceSync:h,getPageJSONSync:l,getAppConfigJSONSync:p,isProjectPage:g,getExtAppId:d,isTabBar:j}}var _exports;init(),module.exports=_exports;