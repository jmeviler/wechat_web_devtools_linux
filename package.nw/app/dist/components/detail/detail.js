"use strict";function init(){function e(e){var t=e?new Date(e):new Date;return t.toLocaleDateString()+" "+t.toLocaleTimeString()}var t=require("../../lib/react.js"),a=require("../../cssStr/cssStr.js"),s=(require("../../utils/tools.js"),require("../../weapp/commit/upload.js")),i=require("../../actions/projectActions.js"),o=require("../../common/log/log.js"),r=(require("../../utils/newReport.js"),require("../../stores/webviewStores.js"),require("../../stores/windowStores.js")),n=require("../../config/errcodeConfig.js"),l=require("../../actions/windowActions.js"),c=require("../../stores/projectStores.js"),p=(require("../../weapp/utils/projectManager.js"),require("./uploadInfo.js")),h=require("./detailConfig.js"),m=require("../../weapp/utils/vendorManager.js"),d=require("fs"),u=6048e5,E=function(e){l.showTipsMsg({msg:e,type:"error"})},_=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};l.showConfirm({content:e,callback:t})},C=t.createClass({displayName:"Detail",getInitialState:function(){var e=this.props.project,t=e.isTourist,a=localStorage["last-up-test-time-"+e.hash],s=localStorage["last-up-load-time-"+e.hash],i=!1;Date.now()-e.newFeature.time<u&&(i=e.newFeature.show);var o=(e.uploadPath.query||"",e.uploadPath.page||"",m.getVendorConfig());return{lazyLoaded:"detail"===this.props.show,lastUploadTime:t?"项目未关联AppID":s?s:"未上传",lastTestTime:t?"项目未关联AppID":a?a:"未提交",testBtnClass:"detail-meta-upload",testBtnTitle:"预览",tabIndex:0,qrcode_img:"",isTourist:t,es6:e.es6,minified:e.minified,watcher:e.watcher,postcss:e.postcss,urlCheck:e.urlCheck,newFeatureCheck:e.newFeature.check,showNewFeatureCheck:i,showCustomButton:!1,isPlatform:e.platform,extAppId:e.ext_appid,libVersionShow:!1,libVersion:e.libVersion,libs:o.libs||{}}},componentWillReceiveProps:function(e){if("detail"===e.show){var t=m.getVendorConfig();this.setState({lazyLoaded:!0,libs:t.libs||{}})}},componentDidMount:function(){r.on("TOGGLE_NEW_FEACHE_CHECK_SHOW_STATUS",this._onToggleNewFeatureCheck),r.on("BODY_CLICK",this._onBodyClick),c.on("PROJECT_EXT_APPID_CHANGED",this._onProjectExtAppidChanged),c.on("ON_VENDOR_LIB_CHANGE",this._onVendorLibChange),m.on("VENDOR_CONFIG_CHANGE",this._onVendorConfigChange)},componentWillUnmount:function(){r.removeListener("TOGGLE_NEW_FEACHE_CHECK_SHOW_STATUS",this._onToggleNewFeatureCheck),r.removeListener("BODY_CLICK",this._onBodyClick),c.removeListener("PROJECT_EXT_APPID_CHANGED",this._onProjectExtAppidChanged),c.removeListener("ON_VENDOR_LIB_CHANGE",this._onVendorLibChange),m.removeListener("VENDOR_CONFIG_CHANGE",this._onVendorConfigChange)},_onVendorLibChange:function(e){this.setState({libVersion:e})},_onBodyClick:function(){this.setState({libVersionShow:!1})},_onToggleNewFeatureCheck:function(e){this.setState({showNewFeatureCheck:e}),c.setProjectNewFeature(this.props.project.hash,{check:this.state.newFeatureCheck,show:e,time:Date.now()}),e&&this.props.optProject("detail")},_onVendorConfigChange:function(e){console.warn(e),this.setState({libs:e.libs||{}})},_onProjectExtAppidChanged:function(e,t){e.hash===this.props.project.hash&&this.setState({extAppId:t})},closeImg:function(){this.setState({qrcode_img:""})},upload:function(){var e=this.props.project,t=e.isTourist;t||this.refs.uploadWnd.startUpload()},openProject:function(e){var t=this,a=d.existsSync(e);a?nw.Shell.openItem(e):_("目录 "+e+" 不存在，是否删除本项目？",function(e){e&&i.del(t.props.project.projectid)})},delProject:function(){var e=this;_("确认删除 "+decodeURIComponent(this.props.project.appname)+" ?",function(t){t&&i.del(e.props.project.projectid)})},uploadForTest:function(e,t){var a=this,i=this.props.project,o=i.isTourist;if(!o&&!this.lock){var r=void 0,n=void 0;t&&(r=t.page||"",n=t.query,c.setProjectUploadPath(this.props.project.hash,{enable:!0,query:n,page:r})),this.setState({testBtnClass:"detail-upload-dialog-button-primary detail-upload-dialog-button-primary-loading",testBtnTitle:"上传中",page:r,query:n,showCustomLayer:!1}),this.lock=!0,setTimeout(function(){s.uploadForTest(a.props.project,{isNewFeature:a.state.showNewFeatureCheck&&a.state.newFeatureCheck,page:r,query:n},function(e,t,s,i){a.getResp({error:e,resp:t,res:s,options:i,type:"test"})})},1e3/60)}},customPreview:function(){this.setState({showCustomButton:!this.state.showCustomButton})},showCustomPreview:function(){var e=this;this.setState({showCustomButton:!1}),l.showCustomPreview({project:this.props.project,type:"upload",callback:function(t){e.uploadForTest("",{page:t.page,query:t.query})}})},getResp:function(t){var a=this;this.lock=!1;var s=t.error,i=(t.resp,t.res),r=t.type,l=t.options,c={testBtnClass:"detail-meta-upload",testBtnTitle:"预览"};if(s){var p="string"==typeof s?s:JSON.stringify(s);_(p||"提交预览出错，请去调试窗口编译代码，查看详细错误信息",function(){a.setState(c)})}else{try{i=JSON.parse(i)}catch(e){return E("系统错误，上传回包："+i),void this.setState(c)}var h=i.baseresponse,m=h?parseInt(h.errcode):0,d=e(),u=parseInt(i.wxpkg_size/1024);if(u&&(d=d+", 编译包大小 "+u+" kb"),0===m){c.qrcode_img=i.qrcode_img;var C=+new Date+15e5,w=new Date(C);c.qrcode_time=w,"test"===r?(c.lastTestTime=d,localStorage.setItem("last-up-test-time-"+this.props.project.hash,d)):(c.lastUploadTime=d,localStorage.setItem("last-up-load-time-"+this.props.project.hash,d)),c.showDailog=!1,this.setState(c)}else{switch(o.error("details.js uploadForTest error "+m),m){case n.DEV_App_Not_Band:_("当前开发者未绑定此 appid ，请到 mp 后台操作后重试"),nw.Shell.openExternal("https://mp.weixin.qq.com/");break;case n.DEV_Need_Admin:_("需要管理员才能进行上传操作，请检查后重试");break;case n.DEV_Need_SCAN_CODE:_("请重新扫码确认");break;case n.DEV_COMPILE_EMPTY_SOURCE:_("代码包为空，请检查后重试");break;case n.DEV_COMPILE_WXPKG_MAX_LIMIT:_("编译包大小为 "+u+" kb，超过限制 "+(u-l.MAX_APP_LENGTH)+" kb，请删除文件后重试");break;case n.DEV_COMPILE_INVALID_WXPKG:_("代码包错误，错误代码 "+m);break;case n.DEV_COMPILE_WXML_FAIL:_("wxml 编译错误，错误信息："+i.compile_err_msg);break;case n.DEV_COMPILE_WXSS_FAIL:_("wxss 编译错误，错误信息："+i.compile_err_msg);break;case n.DEV_COMPILE_INVALID_JSON_FILE:_("json 编译错误，错误信息："+i.compile_err_msg);break;case n.DEV_COMPILE_LACK_OF_FILE:_("缺少文件，错误信息："+i.compile_err_msg);break;case n.DEV_Need_Update:_("工具版本过旧，请升级工具后重试");break;case n.DEV_PLATFORM_NOT_BAND_DEV:_("未为绑定为第三方平台的开发小程序");break;case n.DEV_PLATFORM_INVALID_EXT_APPID:_("无效的 ext_appid");break;case n.DEV_PLATFORM_EXT_APPID_NOT_AUTH:_("ext_appid 未授权");break;default:_("系统错误，错误代码："+m+",错误信息："+h.errmsg)}this.setState(c)}}},onEs6Change:function(){var e=!this.state.es6;c.setProjectEs6(this.props.project.hash,e),this.setState({es6:e})},onPostCss:function(){var e=!this.state.postcss;c.setProjectPostCss(this.props.project.hash,e),this.setState({postcss:e})},onMinified:function(){var e=!this.state.minified;c.setProjectMinified(this.props.project.hash,e),this.setState({minified:e})},onAutoWatcher:function(){var e=!this.state.watcher;c.setProjectWatcher(this.props.project.hash,e),this.setState({watcher:e})},onUrlCheck:function(){var e=!this.state.urlCheck;c.setProjectUrlCheck(this.props.project.hash,e),this.setState({urlCheck:e})},onNewFeatureCheck:function(){var e=!this.state.newFeatureCheck;c.setProjectNewFeature(this.props.project.hash,{check:e?1:0,show:this.state.showNewFeatureCheck,time:Date.now()}),this.setState({newFeatureCheck:e})},changeTab:function(e){this.setState({tabIndex:e})},openNewFeatureDetails:function(e){nw.Window.open("https://mp.weixin.qq.com/debug/wxadoc/dev/devtools/beta.html",{width:799,height:799},function(){}),e.preventDefault(),e.stopPropagation()},onShowLibVersion:function(e){e.stopPropagation(),this.setState({libVersionShow:!this.state.libVersionShow})},onLibSelect:function(e){var t=this;e.stopPropagation();var a=e.currentTarget,s=a.dataset.version;m.changeVendorVersion(s,function(e){return e?void E(e):(c.setProjectLibVersion(t.props.project.hash,s),t.setState({libVersionShow:!1,libVersion:s}),void l.showTipsMsg({msg:"基础库切换成功",type:"success"}))})},render:function(){var e=this;if(!this.state.lazyLoaded)return null;var s=this.props,i=s.show,o=s.project,r=this.state.isTourist,n="detail"===i?{}:a.displayNone,l=o.app_head_img||"../images/logo.png",c=o?decodeURIComponent(o.appname):"",m=o?o.appid:"",d=o?o.projectpath:"",u="",E=a.displayNone,_="",C="";if(this.state.qrcode_img){u=t.createElement("img",{src:"data:image/png;base64,"+this.state.qrcode_img,style:{width:"200px",heigth:"200px",marginBottom:"20px"}}),E={};var w=decodeURIComponent(o.app_nickname)||m;_="使用 "+w+" 绑定的开发者微信扫描并预览当前开发版本",C="二维码仅对当前本有效且将在 "+this.state.qrcode_time.toTimeString().replace(/\s.*/g,"")+" 时失效"}var N=this.state.tabIndex,g=this.state.es6,f=this.state.minified,b=(this.state.watcher,this.state.postcss),v=this.state.urlCheck,k=this.state.newFeatureCheck,j=this.state.showNewFeatureCheck,S=[];for(var P in this.state.libs)S.push(t.createElement("div",{className:"lib-dropdown-item","data-version":P,onClick:this.onLibSelect},P));return t.createElement("div",{className:"detail",style:n},t.createElement("div",{className:"detail-logo-wrapper"},t.createElement("img",{src:l,className:"detail-logo"}),t.createElement("p",{className:"detail-name"},c),t.createElement("div",{style:this.state.isPlatform?{}:a.displayNone},t.createElement("p",{className:"detail-appid"},"第三方平台：",this.props.project.platform_nickname),t.createElement("p",{className:"detail-appid"},"AppID: ",m),t.createElement("p",{className:"detail-appid",style:this.state.extAppId?{}:a.displayNone},"extAppID: ",this.state.extAppId)),t.createElement("div",{style:this.state.isPlatform?a.displayNone:{}},t.createElement("p",{className:"detail-appid"},"AppID: ",m))),t.createElement("div",{className:"detail-meta-tab"},t.createElement("div",{className:"detail-meta-tab-hd",style:this.props.project.isTourist?a.displayNone:{}},t.createElement("a",{href:"javascript:;",onClick:function(){e.changeTab(0)},className:0===N?"detail-meta-tab-item-active":""},"基础信息"),t.createElement("a",{href:"javascript:;",onClick:function(){e.changeTab(1)},className:1===N?"detail-meta-tab-item-active":""},"配置信息")),t.createElement("div",{style:0===N?{}:a.displayNone},t.createElement("div",{className:"detail-meta-tab-bd"},t.createElement("div",{className:"detail-meta-wrapper"},t.createElement("div",{className:"detail-meta"},t.createElement("p",{className:"detail-meta-label"},"本地开发目录"),t.createElement("p",{className:"detail-meta-value"},d),t.createElement("a",{onClick:function(){e.openProject(d)},href:"javascript:;",className:"detail-meta-upload-default"},"打开")),t.createElement("div",{className:"detail-meta "+(r?"detail-meta-disabled":"")},t.createElement("p",{className:"detail-meta-label"},"最新更新时间"),t.createElement("p",{className:"detail-meta-value"},this.state.lastTestTime),t.createElement("div",{className:"detail-meta-btn-group"},t.createElement("a",{onClick:this.uploadForTest,href:"javascript:;",className:this.state.testBtnClass+"  "+(r?"detail-meta-upload-disabled":"")},this.state.testBtnTitle),t.createElement("a",{onClick:this.customPreview,style:r?a.displayNone:{},href:"javascript:;",className:"detail-meta-btn-cert"},t.createElement("i",{className:"icon-arrow-down"})),t.createElement("div",{onClick:this.showCustomPreview,style:this.state.showCustomButton&&!r?{}:a.displayNone,className:"detail-meta-btn-dropdown"},t.createElement("a",{href:"javascript:;",className:"detail-meta-btn-dropdown-item"},"自定义预览")))),t.createElement("div",{className:"detail-meta "+(r?"detail-meta-disabled":"")},t.createElement("p",{className:"detail-meta-label"},"最近上传时间"),t.createElement("p",{className:"detail-meta-value"},this.state.lastUploadTime),t.createElement("a",{onClick:this.upload,href:"javascript:;",className:"detail-meta-upload-default "+(r?"detail-meta-upload-default-disabled":"")},"上传")),t.createElement("div",{className:"detail-meta"},t.createElement("p",{className:"detail-meta-label"},"基础库版本"),t.createElement("p",{className:"detail-meta-value"},t.createElement("div",{className:""},t.createElement("span",null,this.state.libVersion))),t.createElement("div",{className:"lib-dropdown",style:this.state.libVersionShow?{}:a.displayNone},S),t.createElement("a",{href:"javascript:;",onClick:this.onShowLibVersion},t.createElement("span",null,"更换"),t.createElement("i",{className:this.state.libVersionShow?"lib-dropdown-icon-up":"lib-dropdown-icon-down"}))),t.createElement("div",{className:"detail-meta detail-meta-column"},t.createElement("label",{htmlFor:"es6toes5",onClick:this.onEs6Change,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:g}),t.createElement("i",null),"开启 ES6 转 ES5"),t.createElement("label",{htmlFor:"postcss",onClick:this.onPostCss,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:b}),t.createElement("i",null),"开启 上传代码时样式文件自动补全"),t.createElement("label",{htmlFor:"minified",onClick:this.onMinified,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:f}),t.createElement("i",null),"开启 代码压缩上传"),t.createElement("label",{htmlFor:"urlCheck",onClick:this.onUrlCheck,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:!v}),t.createElement("i",null),"开发环境不校验请求域名、TLS 版本以及 HTTPS 证书"),t.createElement("label",{htmlFor:"urlCheck",onClick:this.onNewFeatureCheck,className:"detail-meta-es6toes5",style:j?{}:a.displayNone},t.createElement("input",{type:"checkbox",checked:k}),t.createElement("i",null),"使用测试服务器进行预览 ")))),t.createElement("div",{className:"detail-opr-wrapper"},t.createElement("a",{onClick:this.delProject,href:"javascript:;",className:"button"},"删除项目"))),t.createElement(h,{show:1===N,project:this.props.project})),t.createElement(p,{ref:"uploadWnd",getResp:this.getResp,isTourist:r,project:this.props.project}),t.createElement("div",{className:"setting-show",style:E},t.createElement("div",{className:"setting-hd"},t.createElement("h3",{className:"setting-hd-title"},"预览")),t.createElement("div",{className:"setting-bd"},u,t.createElement("p",null,_),t.createElement("p",null,C)),t.createElement("div",{className:"setting-ft"},t.createElement("a",{href:"javascript:;",onClick:this.closeImg,className:"setting-button-default"},"确定"))))}});_exports=C}var _exports;init(),module.exports=_exports;