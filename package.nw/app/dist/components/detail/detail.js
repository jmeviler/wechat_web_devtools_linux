"use strict";function init(){function e(e){var t=e?new Date(e):new Date;return t.toLocaleDateString()+" "+t.toLocaleTimeString()}var t=require("../../lib/react.js"),a=require("../../cssStr/cssStr.js"),s=(require("../../utils/tools.js"),require("../../weapp/commit/upload.js")),i=require("../../actions/projectActions.js"),o=require("../../common/log/log.js"),r=(require("../../utils/newReport.js"),require("../../stores/webviewStores.js"),require("../../stores/windowStores.js")),l=require("../../config/errcodeConfig.js"),c=require("../../actions/windowActions.js"),n=require("../../stores/projectStores.js"),p=(require("../../weapp/utils/projectManager.js"),require("./uploadInfo.js")),m=require("./detailConfig.js"),h=6048e5,d=function(e){c.showTipsMsg({msg:e,type:"error"})},u=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};c.showConfirm({content:e,callback:t})},E=t.createClass({displayName:"Detail",getInitialState:function(){var e=this.props.project,t=e.isTourist,a=localStorage["last-up-test-time-"+e.hash],s=localStorage["last-up-load-time-"+e.hash],i=!1;Date.now()-e.newFeature.time<h&&(i=e.newFeature.show),global.appConfig.isBeta&&(i=!0);e.uploadPath.query||"",e.uploadPath.page||"";return{lazyLoaded:"detail"===this.props.show,lastUploadTime:t?"项目未关联AppID":s?s:"未上传",lastTestTime:t?"项目未关联AppID":a?a:"未提交",testBtnClass:"detail-meta-upload",testBtnTitle:"预览",tabIndex:0,qrcode_img:"",isTourist:t,es6:e.es6,minified:e.minified,watcher:e.watcher,postcss:e.postcss,urlCheck:e.urlCheck,newFeatureCheck:e.newFeature.check,showNewFeatureCheck:i,showCustomButton:!1,isPlatform:e.platform,extAppId:e.ext_appid}},componentWillReceiveProps:function(e){"detail"===e.show&&this.setState({lazyLoaded:!0})},componentDidMount:function(){r.on("TOGGLE_NEW_FEACHE_CHECK_SHOW_STATUS",this._onToggleNewFeatureCheck),n.on("PROJECT_EXT_APPID_CHANGED",this._onProjectExtAppidChanged)},componentWillUnmount:function(){r.removeListener("TOGGLE_NEW_FEACHE_CHECK_SHOW_STATUS",this._onToggleNewFeatureCheck),n.removeListener("PROJECT_EXT_APPID_CHANGED",this._onProjectExtAppidChanged)},_onProjectExtAppidChanged:function(e,t){e.hash===this.props.project.hash&&this.setState({extAppId:t})},_onToggleNewFeatureCheck:function(e){this.setState({showNewFeatureCheck:e}),n.setProjectNewFeature(this.props.project.hash,{check:this.state.newFeatureCheck,show:e,time:Date.now()}),e&&this.props.optProject("detail")},closeImg:function(){this.setState({qrcode_img:""})},upload:function(){var e=this.props.project,t=e.isTourist;t||this.refs.uploadWnd.startUpload()},openProject:function(e){nw.Shell.openItem(e)},delProject:function(){var e=this;u("确认删除 "+decodeURIComponent(this.props.project.appname)+" ?",function(t){t&&i.del(e.props.project.projectid)})},uploadForTest:function(e,t){var a=this,i=this.props.project,o=i.isTourist;if(!o&&!this.lock){var r=void 0,l=void 0;t&&(r=t.page||"",l=t.query,n.setProjectUploadPath(this.props.project.hash,{enable:!0,query:l,page:r})),this.setState({testBtnClass:"detail-upload-dialog-button-primary detail-upload-dialog-button-primary-loading",testBtnTitle:"上传中",page:r,query:l,showCustomLayer:!1}),this.lock=!0,setTimeout(function(){s.uploadForTest(a.props.project,{isNewFeature:a.state.showNewFeatureCheck&&a.state.newFeatureCheck,page:r,query:l},function(e,t,s,i){a.getResp({error:e,resp:t,res:s,options:i,type:"test"})})},1e3/60)}},customPreview:function(){this.setState({showCustomButton:!this.state.showCustomButton})},showCustomPreview:function(){var e=this;this.setState({showCustomButton:!1}),c.showCustomPreview({project:this.props.project,type:"upload",callback:function(t){e.uploadForTest("",{page:t.page,query:t.query})}})},getResp:function(t){var a=this;this.lock=!1;var s=t.error,i=(t.resp,t.res),r=t.type,c=t.options,n={testBtnClass:"detail-meta-upload",testBtnTitle:"预览"};if(s){var p="string"==typeof s?s:JSON.stringify(s);u(p||"提交预览出错，请去调试窗口编译代码，查看详细错误信息",function(){a.setState(n)})}else{try{i=JSON.parse(i)}catch(e){return d("系统错误，上传回包："+i),void this.setState(n)}var m=i.baseresponse,h=m?parseInt(m.errcode):0,E=e(),_=parseInt(i.wxpkg_size/1024);if(_&&(E=E+", 编译包大小 "+_+" kb"),0===h){n.qrcode_img=i.qrcode_img;var w=+new Date+15e5,C=new Date(w);n.qrcode_time=C,"test"===r?(n.lastTestTime=E,localStorage.setItem("last-up-test-time-"+this.props.project.hash,E)):(n.lastUploadTime=E,localStorage.setItem("last-up-load-time-"+this.props.project.hash,E)),n.showDailog=!1,this.setState(n)}else{switch(o.error("details.js uploadForTest error "+h),h){case l.DEV_App_Not_Band:u("当前开发者未绑定此 appid ，请到 mp 后台操作后重试"),nw.Shell.openExternal("https://mp.weixin.qq.com/");break;case l.DEV_Need_Admin:u("需要管理员才能进行上传操作，请检查后重试");break;case l.DEV_Need_SCAN_CODE:u("请重新扫码确认");break;case l.DEV_COMPILE_EMPTY_SOURCE:u("代码包为空，请检查后重试");break;case l.DEV_COMPILE_WXPKG_MAX_LIMIT:u("编译包大小为 "+_+" kb，超过限制 "+(_-c.MAX_APP_LENGTH)+" kb，请删除文件后重试");break;case l.DEV_COMPILE_INVALID_WXPKG:u("代码包错误，错误代码 "+h);break;case l.DEV_COMPILE_WXML_FAIL:u("wxml 编译错误，错误信息："+i.compile_err_msg);break;case l.DEV_COMPILE_WXSS_FAIL:u("wxss 编译错误，错误信息："+i.compile_err_msg);break;case l.DEV_COMPILE_INVALID_JSON_FILE:u("json 编译错误，错误信息："+i.compile_err_msg);break;case l.DEV_COMPILE_LACK_OF_FILE:u("缺少文件，错误信息："+i.compile_err_msg);break;case l.DEV_Need_Update:u("工具版本过旧，请升级工具后重试");break;case l.DEV_PLATFORM_NOT_BAND_DEV:u("未为绑定为第三方平台的开发小程序");break;case l.DEV_PLATFORM_INVALID_EXT_APPID:u("无效的 ext_appid");break;case l.DEV_PLATFORM_EXT_APPID_NOT_AUTH:u("ext_appid 未授权");break;default:u("系统错误，错误代码："+h+",错误信息："+m.errmsg)}this.setState(n)}}},onEs6Change:function(){var e=!this.state.es6;n.setProjectEs6(this.props.project.hash,e),this.setState({es6:e})},onPostCss:function(){var e=!this.state.postcss;n.setProjectPostCss(this.props.project.hash,e),this.setState({postcss:e})},onMinified:function(){var e=!this.state.minified;n.setProjectMinified(this.props.project.hash,e),this.setState({minified:e})},onAutoWatcher:function(){var e=!this.state.watcher;n.setProjectWatcher(this.props.project.hash,e),this.setState({watcher:e})},onUrlCheck:function(){var e=!this.state.urlCheck;n.setProjectUrlCheck(this.props.project.hash,e),this.setState({urlCheck:e})},onNewFeatureCheck:function(){var e=!this.state.newFeatureCheck;n.setProjectNewFeature(this.props.project.hash,{check:e?1:0,show:this.state.showNewFeatureCheck,time:Date.now()}),this.setState({newFeatureCheck:e})},changeTab:function(e){this.setState({tabIndex:e})},openNewFeatureDetails:function(e){nw.Window.open("https://mp.weixin.qq.com/debug/wxadoc/dev/devtools/beta.html",{width:799,height:799},function(){}),e.preventDefault(),e.stopPropagation()},render:function(){var e=this;if(!this.state.lazyLoaded)return null;var s=this.props,i=s.show,o=s.project,r=this.state.isTourist,l="detail"===i?{}:a.displayNone,c=o.app_head_img||"../images/logo.png",n=o?decodeURIComponent(o.appname):"",h=o?o.appid:"",d=o?o.projectpath:"",u="",E=a.displayNone,_="",w="";if(this.state.qrcode_img){u=t.createElement("img",{src:"data:image/png;base64,"+this.state.qrcode_img,style:{width:"200px",heigth:"200px",marginBottom:"20px"}}),E={};var C=decodeURIComponent(o.app_nickname)||h;_="使用 "+C+" 绑定的开发者微信扫描并预览当前开发版本",w="二维码仅对当前本有效且将在 "+this.state.qrcode_time.toTimeString().replace(/\s.*/g,"")+" 时失效"}var N=this.state.tabIndex,g=this.state.es6,f=this.state.minified,k=this.state.watcher,v=this.state.postcss,j=this.state.urlCheck,b=this.state.newFeatureCheck,P=this.state.showNewFeatureCheck;return t.createElement("div",{className:"detail",style:l},t.createElement("div",{className:"detail-logo-wrapper"},t.createElement("img",{src:c,className:"detail-logo"}),t.createElement("p",{className:"detail-name"},n),t.createElement("div",{style:this.state.isPlatform?{}:a.displayNone},t.createElement("p",{className:"detail-appid"},"第三方平台：",this.props.project.platform_nickname),t.createElement("p",{className:"detail-appid"},"AppID: ",h),t.createElement("p",{className:"detail-appid",style:this.state.extAppId?{}:a.displayNone},"extAppID: ",this.state.extAppId)),t.createElement("div",{style:this.state.isPlatform?a.displayNone:{}},t.createElement("p",{className:"detail-appid"},"AppID: ",h))),t.createElement("div",{className:"detail-meta-tab"},t.createElement("div",{className:"detail-meta-tab-hd",style:this.props.project.isTourist?a.displayNone:{}},t.createElement("a",{href:"javascript:;",onClick:function(){e.changeTab(0)},className:0===N?"detail-meta-tab-item-active":""},"基础信息"),t.createElement("a",{href:"javascript:;",onClick:function(){e.changeTab(1)},className:1===N?"detail-meta-tab-item-active":""},"配置信息")),t.createElement("div",{style:0===N?{}:a.displayNone},t.createElement("div",{className:"detail-meta-tab-bd"},t.createElement("div",{className:"detail-meta-wrapper"},t.createElement("div",{className:"detail-meta"},t.createElement("p",{className:"detail-meta-label"},"本地开发目录"),t.createElement("p",{className:"detail-meta-value"},d),t.createElement("a",{onClick:function(){e.openProject(d)},href:"javascript:;",className:"detail-meta-upload-default"},"打开")),t.createElement("div",{className:"detail-meta "+(r?"detail-meta-disabled":"")},t.createElement("p",{className:"detail-meta-label"},"最新更新时间"),t.createElement("p",{className:"detail-meta-value"},this.state.lastTestTime),t.createElement("div",{className:"detail-meta-btn-group"},t.createElement("a",{onClick:this.uploadForTest,href:"javascript:;",className:this.state.testBtnClass+"  "+(r?"detail-meta-upload-disabled":"")},this.state.testBtnTitle),t.createElement("a",{onClick:this.customPreview,style:r?a.displayNone:{},href:"javascript:;",className:"detail-meta-btn-cert"},t.createElement("i",{className:"icon-arrow-down"})),t.createElement("div",{onClick:this.showCustomPreview,style:this.state.showCustomButton&&!r?{}:a.displayNone,className:"detail-meta-btn-dropdown"},t.createElement("a",{href:"javascript:;",className:"detail-meta-btn-dropdown-item"},"自定义预览")))),t.createElement("div",{className:"detail-meta "+(r?"detail-meta-disabled":"")},t.createElement("p",{className:"detail-meta-label"},"最近上传时间"),t.createElement("p",{className:"detail-meta-value"},this.state.lastUploadTime),t.createElement("a",{onClick:this.upload,href:"javascript:;",className:"detail-meta-upload-default "+(r?"detail-meta-upload-default-disabled":"")},"上传")),t.createElement("div",{className:"detail-meta detail-meta-column"},t.createElement("label",{htmlFor:"es6toes5",onClick:this.onEs6Change,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:g}),t.createElement("i",null),"开启 ES6 转 ES5"),t.createElement("label",{htmlFor:"postcss",onClick:this.onPostCss,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:v}),t.createElement("i",null),"开启 上传代码时样式文件自动补全"),t.createElement("label",{htmlFor:"minified",onClick:this.onMinified,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:f}),t.createElement("i",null),"开启 代码压缩上传"),t.createElement("label",{htmlFor:"watcher",onClick:this.onAutoWatcher,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:k}),t.createElement("i",null),"监听文件变化，自动刷新开发者工具"),t.createElement("label",{htmlFor:"urlCheck",onClick:this.onUrlCheck,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:!j}),t.createElement("i",null),"开发环境不校验请求域名以及 TLS 版本"),t.createElement("label",{htmlFor:"urlCheck",onClick:this.onNewFeatureCheck,className:"detail-meta-es6toes5",style:P?{}:a.displayNone},t.createElement("input",{type:"checkbox",checked:b}),t.createElement("i",null),"使用测试服务器进行预览 ")))),t.createElement("div",{className:"detail-opr-wrapper"},t.createElement("a",{onClick:this.delProject,href:"javascript:;",className:"button"},"删除项目"))),t.createElement(m,{show:1===N,project:this.props.project})),t.createElement(p,{ref:"uploadWnd",getResp:this.getResp,isTourist:r,project:this.props.project}),t.createElement("div",{className:"setting-show",style:E},t.createElement("div",{className:"setting-hd"},t.createElement("h3",{className:"setting-hd-title"},"预览")),t.createElement("div",{className:"setting-bd"},u,t.createElement("p",null,_),t.createElement("p",null,w)),t.createElement("div",{className:"setting-ft"},t.createElement("a",{href:"javascript:;",onClick:this.closeImg,className:"setting-button-default"},"确定"))))}});_exports=E}var _exports;init(),module.exports=_exports;