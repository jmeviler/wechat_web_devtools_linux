"use strict";function init(){var e=require("../../lib/react.js"),t=(require("../../stores/windowStores.js"),require("../../actions/windowActions.js")),a=(require("../../cssStr/cssStr.js"),require("../../weapp/commit/upload.js")),i=require("../../common/request/request.js"),s=require("../../config/urlConfig.js"),o=s.uploadQrCodeURL,r=s.refreshUploadConfirm,l=require("../../config/errcodeConfig.js"),d=3e5,n={ERR_UUID:1,EXPIRE_UUID:2,WAITING_SCAN:3,WAITING_CONFIRM:4,CONFIRM:5},c=function(e){t.showTipsMsg({msg:e,type:"error"})},m=function(e,a){t.showConfirm({content:e,callback:a})},p=e.createClass({displayName:"UploadInfo",getInitialState:function(){return{show:!1,showDialog:!1,showQrcode:!1,waitingConfirm:!1,qrcode_img:"",qrcode_id:"",version:"",desc:"",saveBtnTitle:"上传",saveBtnClass:"detail-upload-dialog-button-primary"}},startUpload:function(){var e=this;this.setState({showQrcode:!1,showDialog:!1,waitingConfirm:!1});var t=this.props.project.appid,a={url:o+"?appid="+t,method:"get",needToken:1};i(a,function(t,a,i){if(!t&&200===a.statusCode){i=JSON.parse(i);var s=i.baseresponse;0==s.errcode?1!=i.is_experience||e.props.project.platform?e.showQrcodeWnd(i.qrcode_img,i.wxa_uuid):m("您的上次提交已被选为体验版，本次上传将会覆盖体验版，是否继续？",function(t){t&&e.showQrcodeWnd(i.qrcode_img,i.wxa_uuid)}):m(s.errcode==l.DEV_Need_Admin?"需要管理员才能进行上传操作，请检查后重试":"获取二维码失败！"+s.errcode)}})},showQrcodeWnd:function(e,t){this.setState({qrcode_img:e,qrcode_id:t,showQrcode:!0,showDialog:!1}),this.startRefreshTime=Date.now(),this.startRefreshConfirm()},startRefreshConfirm:function(){var e=this;return clearTimeout(this.timeId),Date.now()-this.startRefreshTime>d?(c("二维码已过期！"),void this.setState({showQrcode:!1,showDialog:!1})):void(this.timeId=setTimeout(function(){if(!e.state.showDialog){var t={appid:e.props.project.appid,wxa_uuid:e.state.qrcode_id},a={url:r,body:JSON.stringify(t),method:"post",needToken:1};i(a,function(t,a,i){if(!t&&200===a.statusCode){i=JSON.parse(i);var s=i.baseresponse;if(0==s.errcode)switch(i.qrcode_state){case n.ERR_UUID:c("二维码错误！"),clearTimeout(e.timeId);break;case n.EXPIRE_UUID:c("二维码已过期！"),clearTimeout(e.timeId);break;case n.WAITING_SCAN:break;case n.WAITING_CONFIRM:e.setState({waitingConfirm:!0});break;case n.CONFIRM:e.setState({showQrcode:!1,showDialog:!0}),clearTimeout(e.timeId)}else c("获取二维码状态失败！"),clearTimeout(e.timeId)}}),e.startRefreshConfirm()}},3e3))},save:function(){var e=this;if(!this.lock&&this.state.showDialog){if(!this.state.version)return void c("请填写版本信息");if(!this.state.desc)return void c("请填写描述信息");this.setState({saveBtnClass:"detail-upload-dialog-button-primary detail-upload-dialog-button-primary-loading",saveBtnTitle:"上传中"}),this.lock=!0;var t={version:this.state.version,desc:this.state.desc,uuid:this.state.qrcode_id};a.upload(this.props.project,t,function(t,a,i,s){e.getResp({error:t,resp:a,res:i,options:s,type:"upload"})})}},cancel:function(){this.lock||this.setState({showQrcode:!1,showDialog:!1})},versionChange:function(e){var t=e.target.value;t=t.replace(/[^0-9a-zA-Z\.]/g,""),this.setState({version:t})},descChange:function(e){var t=e.target.value;this.setState({desc:t})},getResp:function(e){this.setState({saveBtnClass:"detail-upload-dialog-button-primary",saveBtnTitle:"上传",showDialog:!1,showQrcode:!1}),this.lock=!1,this.props.getResp(e)},render:function(){var t=this.state.showDialog||this.state.showQrcode,a="";if(this.state.qrcode_img){var i=+new Date+d,s=new Date(i);a=this.state.waitingConfirm?"扫码成功，请在手机上确认":"请使用微信号扫描二维码，并在微信上确认。二维码将在 "+s.toTimeString().replace(/\s.*/g,"")+" 失效。"}return e.createElement("div",{style:{marginTop:-51,display:t?"":"none"},className:"detail-upload-dialog"},e.createElement("div",{className:"detail-upload-dialog-hd"},e.createElement("h3",{className:"detail-upload-dialog-hd-title"},"上传确认")),e.createElement("div",{style:{display:this.state.showDialog?"":"none"}},e.createElement("div",{className:"detail-upload-dialog-bd"},e.createElement("p",{className:"detail-upload-dialog-tips"},"上传后，可以在公众平台查看本版本"),e.createElement("div",{className:"detail-upload-dialog-form"},e.createElement("div",{className:"detail-upload-dialog-form-item"},e.createElement("label",{className:"detail-upload-dialog-form-label"},"版本号"),e.createElement("div",{className:"detail-upload-dialog-form-input-box"},e.createElement("input",{onChange:this.versionChange,value:this.state.version,type:"text",maxLength:"10",className:"detail-upload-dialog-form-input"}),e.createElement("p",{className:"detail-upload-dialog-form-tips"},"合理设置版本号便于管理，只能输入字母、数字、. 如 v1.0.0 "))),e.createElement("div",{className:"detail-upload-dialog-form-item"},e.createElement("label",{className:"detail-upload-dialog-form-label"},"项目备注"),e.createElement("div",{className:"detail-upload-dialog-form-input-box"},e.createElement("input",{onChange:this.descChange,value:this.state.desc,type:"text",maxLength:"100",className:"detail-upload-dialog-form-input"}),e.createElement("p",{className:"detail-upload-dialog-form-tips"},"可以备注项目版本优化内容等，便于管理员识别"))))),e.createElement("div",{className:"detail-upload-dialog-ft"},e.createElement("a",{onClick:this.cancel,href:"javascript:;",className:"detail-upload-dialog-button-default"},"取消"),e.createElement("a",{onClick:this.save,href:"javascript:;",style:{display:this.props.isTourist?"none":""},className:this.state.saveBtnClass},this.state.saveBtnTitle))),e.createElement("div",{style:{display:this.state.showQrcode?"":"none"}},e.createElement("div",{className:"setting-bd"},e.createElement("img",{src:"data:image/png;base64,"+this.state.qrcode_img,style:{width:"200px",heigth:"200px",marginBottom:"20px"}}),e.createElement("p",null,a)),e.createElement("div",{className:"detail-upload-dialog-ft"},e.createElement("a",{onClick:this.cancel,href:"javascript:;",className:"detail-upload-dialog-button-default"},"取消"))))}});_exports=p}var _exports;init(),module.exports=_exports;