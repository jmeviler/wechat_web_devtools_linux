"use strict";function init(){function e(e){return e.replace(/\\/g,"/")}function t(e){return{mtime:+e.mtime,birthtime:+e.birthtime,isDir:e.isDirectory(),size:e.size}}function r(e){try{return i.lstatSync(e)}catch(e){return{isDirectory:function(){return!1}}}}var s=require("glob"),i=require("fs"),n=require("path"),o=require("url"),a=require("rmdir"),c=require("../../lib/react.js"),p=require("../../cssStr/cssStr.js"),h=(require("../../actions/webviewActions.js"),require("../../actions/windowActions.js")),u=require("../../stores/windowStores.js"),d=require("../../actions/projectActions.js"),f=require("../../weapp/utils/tools.js"),l=require("../../weapp/utils/projectManager.js"),E=require("../../stores/projectStores.js"),m=require("../../common/log/log.js"),_=require("child_process"),w=_.spawn,v=(_.spawnSync,_.exec,require("./utils/editTools.js")),g=require("./utils/grep.js"),R=require("./utils/formatCode.js"),S=require("./config/config.js"),b=S.pageJS,j=S.pageJSON,N=S.pageWXML,I=S.pageWXSS,T={".js":b,".wxml":N,".json":j,".wxss":I},D={},y=!1,A=("win32"===process.platform,{".jpg":!0,".png":!0,".jpeg":!0,".icon":!0,".gif":!0,".svg":!0,".cer":!0}),L=function(e){h.showTipsMsg({msg:e,type:"error"})},M=function(e,t){h.showConfirm({content:e,callback:t})},C=c.createClass({displayName:"Edit",getInitialState:function(){return{project:this.props.project}},onMessage:function(c){var p=this,h=c.command,m=c.msg,_=c.ext,S=this.state.project;switch(h){case"GET_FILE_LIST":if(y)return;y=!0;var b=m.options,j=b.ignore||["node_modules/**/*","node_modules"];s("**",{cwd:S.projectpath,ignore:j,nosort:!0,strict:!1,silent:!0},function(e,s){y=!1;for(var i={ret:e?e.toString():0,res:{files:e?[]:s,info:{}}},o=0;o<s.length;o++){var a=s[o],c=n.join(S.projectpath,a),h=r(c),u=h.isDirectory();u&&(s[o]=a+"/"),s[o]="/"+s[o],i.res.info[s[o]]=t(h)}s.forEach(function(e){D[e]=!0}),i.res.projectpath=S.projectpath,p.postMessage("webframe","RETURN_RES",i,_)});break;case"GET_FILE_DATA":var N=m.path,I=n.extname(N);if(A[I]){var L="";try{L=decodeURI(o.resolve(f.getBaseURL(S),N))}catch(e){L=o.resolve(f.getBaseURL(S),N)}this.postMessage("webframe","RETURN_RES",{ret:0,res:{data:L}},_)}else{var M=n.join(S.projectpath,N);i.readFile(M,"utf8",function(e,s){var i=r(M),n=t(i),o={ret:e?e.toString():0,res:{data:e?"":s,info:n}};p.postMessage("webframe","RETURN_RES",o,_)})}break;case"SAVE_FILE_DATA":var C=n.join(S.projectpath,m.path),O=m.data,W=void 0;try{i.writeFileSync(C,O,"utf8");var F=i.lstatSync(C),U=+F.mtime;if(D[e(m.path)]=U,W={ret:0,res:{path:m.path,info:t(F)}},"/app.json"===m.path)try{var P=JSON.parse(O),k=P.pages||[];v.initPage(S,k)}catch(e){}}catch(e){W={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",W,_);break;case"DEL_FILE":var q=m.path,B=void 0;try{i.unlinkSync(n.join(S.projectpath,q)),q=e(q),B={ret:0,res:q},delete D[q]}catch(e){B={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",B,_);break;case"RENAME_FILE":var x=n.join(S.projectpath,m.oldPath),G=n.join(S.projectpath,m.newPath),H=void 0,J=r(x);if(J.isDirectory()){l.manager.stopWatch();var V="darwin"===process.platform?"mv":"ren",Q="darwin"===process.platform?['"'+x+'"','"'+G+'"']:['"'+x+'"','"'+n.relative(n.dirname(G),G)+'"'],X=[],z=[],K=w(V,Q,{shell:!0});K.on("close",function(e){l.manager.restartWatch(),H=0===e?{ret:0,res:{path:m.newPath,info:t(J)}}:{ret:"目录修改错误",res:""},p.postMessage("webframe","RETURN_RES",H,_)}),K.stdout.on("data",function(e){X.push(e)}),K.stderr.on("data",function(e){z.push(e)})}else{try{i.renameSync(x,G),delete D[e(m.oldPath)];var Y=i.lstatSync(G);D[m.newPath]=!0,H={ret:0,res:{path:m.newPath,info:t(Y)}}}catch(e){H={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",H,_)}break;case"RM_DIR":var Z=S.projectpath,$=n.join(Z,m.path);a($,function(t,r,s){t||(r.forEach(function(t){var r=n.relative(Z,t);r=e(r),delete D[r]}),s.forEach(function(t){var r=n.relative(Z,t);r=e(r),delete D[r]}));var i={ret:t?t.toString():0,res:t?"":r};p.postMessage("webframe","RETURN_RES",i,_)});break;case"ADD_FILE":var ee=n.join(S.projectpath,m.path),te=i.existsSync(ee),re=void 0;if(te)re={ret:m.path+" already existed"},this.postMessage("webframe","RETURN_RES",re,_);else{try{i.writeFileSync(ee,"","utf8"),D[e(m.path)]=!0;var se=i.lstatSync(ee);re={ret:0,res:{path:m.path,info:t(se)}}}catch(e){re={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",re,_)}break;case"ADD_PAGE":var ie=n.join(S.projectpath,m.path),ne=m.name,oe={ret:0,res:[]},ae=!1;for(var ce in T){var pe=n.join(ie,""+ne+ce);if(!i.existsSync(pe)){var he=T[ce].replace(/{{page}}/g,ne);try{i.writeFileSync(pe,he,"utf8"),D[e(pe)]=!0;var ue=i.lstatSync(ie);oe.res.push({path:e(n.join(m.path,m.name+ce)),info:t(ue)})}catch(e){ae=!0,oe={ret:e.toString(),res:""}}}}if(!ae){var de=n.join(S.projectpath,"app.json"),fe=JSON.parse(i.readFileSync(de,"utf8"));"/"===m.path[0]&&(m.path=m.path.substr(1));var le=fe.pages||[];le.push(e(n.join(m.path,m.name))),fe.pages=le;try{i.writeFileSync(de,JSON.stringify(fe,null,parseInt(u.getEditorConfig("tabSize"))),"utf8")}catch(e){ae=!0,oe={ret:e.toString(),res:""}}}this.postMessage("webframe","RETURN_RES",oe,_);break;case"MAKE_DIR":var Ee=n.join(S.projectpath,m.path),me=void 0;try{i.mkdirSync(Ee),D[e(m.path)]=!0;var _e=i.lstatSync(Ee);me={ret:0,res:{path:Ee,info:t(_e)}}}catch(e){me={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",me,_);break;case"GET_PROJECT_INFO":this.postMessage("webframe","RETURN_RES",{ret:0,res:S},_);break;case"SET_EDIT_WEBVIEW":var we=m.editWebview;E.setProjectEditWebview(S.hash,we),this.postMessage("webframe","RETURN_RES",{ret:0,res:we},_);break;case"FIND_STR":var ve=m.options,ge=m.str,Re=ve.cwd,Se=ve.i,be=ve.wholeword;Re=n.join(S.projectpath,Re),g({str:ge,cwd:Re,i:Se,wholeword:be,project:S},function(e,t){var r={};e?r.ret=JSON.stringify(e):(r.ret=0,r.res=t),p.postMessage("webframe","RETURN_RES",r,_)});break;case"SHOW_ITEM_IN_FOLDER":var je=n.join(S.projectpath,m.filePath);nw.Shell.showItemInFolder(je);break;case"FORMAT_CODE":var Ne=m.code,Ie=m.options;R(Ne,Ie,function(e,t){var r={ret:0,res:t};p.postMessage("webframe","RETURN_RES",r,_)});break;case"REBUILD":d.restartImmediate(m);break;case"SET_CLIPBOARD":nw.Clipboard.get().set({data:m.data,type:"text"})}},postMessage:function(e,t,r,s){var i=this,n={to:e,msg:r,command:t,ext:s};return this.port?(this.msgQuery.length&&(this.msgQuery.forEach(function(e){i.port.postMessage(e)}),this.msgQuery=[]),void this.port.postMessage(n)):void this.msgQuery.push(n)},initport:function(e){var t=this;"edit"===e.name&&(this.port=e,this.port.onMessage.addListener(this.onMessage),this.port.onDisconnect.addListener(function(){t.port.onMessage.removeListener(t.onMessage),delete t.port,delete t.portID,t.msgQuery=[]}),this.postMessage("contentscript","SHAKE_HANDS",{}))},initRuntime:function(){chrome.runtime.onConnect.addListener(this.initport)},addContentScripts:function(){this.webview.addContentScripts([{name:"contentscript",matches:["<all_urls>"],js:{files:["app/dist/contentscript/editcontent.js"]},run_at:"document_start"}])},ewWindow:function(){this.webview.addEventListener("newwindow",function(e){var t=e.targetUrl;t&&nw.Window.open(t,{width:799,height:799})})},_windowFocus:function(){var e=this;if("focus"!==this.currentStatus){var t={eventType:"focus"};this.postMessage("webframe","WINDOW_CHANGE",t,{}),setTimeout(function(){e.webview.focus()},100),this.currentStatus="focus"}},_windowBlur:function(){if("blur"!==this.currentStatus){var e={eventType:"blur"};this.postMessage("webframe","WINDOW_CHANGE",e,{}),this.currentStatus="blur"}},_editWebview:function(e,t){e.hash===this.props.project.hash&&this.postMessage("webframe","WEBVIEW_SHOW_CHANGE",{editWebview:t},{})},_openProjectFile:function(e){var t=this,r=u.getLastShow();"edit"===r||this.props.optProject("edit",function(){setImmediate(function(){t.webview.focus(),t.postMessage("webframe","OPEN_FILE",e,{})})})},_updateEditorConfig:function(e){this.postMessage("webframe","UPDATE_EDITOR_CONFIG",e)},_saveAllAndRebuild:function(e){this.postMessage("webframe","SAVE_ALL_AND_REBUILD",e)},_transferEditorCommand:function(e){var t=this;setImmediate(function(){t.webview.focus()}),this.postMessage("webframe","EXEC_EDITOR_COMMAND",e)},componentDidMount:function(){this.msgQuery=[],this.show=this.props.show;var e=this.refs.container,t=this.webview=document.createElement("webview");t.className="simulator-bd-webview_body",t.setAttribute("partition","persist:trusted"),t.setAttribute("tabIndex","-1"),t.setUserAgentOverride(t.getUserAgent()+" devtoolsedit"),e.appendChild(t),this.ewWindow(),this.addContentScripts(),this.initRuntime(),t.addEventListener("dialog",function(e){var t=e.messageType||"",r=e.messageText,s=e.dialog;if("alert"===t)L(r);else if("confirm"===t)e.preventDefault(),M(r,function(e){e?s.ok():s.cancel()});else if("prompt"===t){var i=prompt(r);null!==i?s.ok(i):s.cancel()}}),t.addEventListener("blur",function(e){h.editorBlur()}),t.addEventListener("focus",function(e){h.editorFocus()});var r=l.manager;r.on("FILE_CHANGE",this._initWatcher),t.src="app/html/edit.html",u.on("WINDOW_BLUR",this._windowFocus),u.on("WINDOW_FOCUS",this._windowBlur),E.on("PROJECT_STORES_CHANGE_EDIT_WEBVIEW",this._editWebview),u.on("OPEN_PROJECT_FILE",this._openProjectFile),u.on("UPDATE_EDITOR_CONFIG",this._updateEditorConfig),u.on("EXEC_EDITOR_COMMAND",this._transferEditorCommand),E.on("SAVE_ALL_AND_REBUILD",this._saveAllAndRebuild)},componentWillUnmount:function(){chrome.runtime.onConnect.removeListener(this.initport),u.removeListener("WINDOW_BLUR",this._windowFocus),u.removeListener("WINDOW_FOCUS",this._windowBlur),E.removeListener("PROJECT_STORES_CHANGE_EDIT_WEBVIEW",this._editWebview),u.removeListener("OPEN_PROJECT_FILE",this._openProjectFile),u.removeListener("UPDATE_EDITOR_CONFIG",this._updateEditorConfig),u.removeListener("EXEC_EDITOR_COMMAND",this._transferEditorCommand),E.removeListener("SAVE_ALL_AND_REBUILD",this._saveAllAndRebuild);var e=l.manager;e.removeListener("FILE_CHANGE",this._initWatcher),this.webview.remove(),D={}},_initWatcher:function(r,s,i,o){if(r.hash===this.state.project.hash){var a=o?+o.mtime:0,c=o?t(o):{},p={};i=e(i);var h=(n.join(r.projectpath,i),D[i]);if("unlinkDir"===s&&(h=D[i+"/"]),"add"!==s&&"addDir"!==s||h)if("unlink"!==s&&"unlinkDir"!==s||!h){if("change"!==s)return void m.info("edit.js watch "+s);if(D[i]===a)return;D[i]=a,p={eventType:s,fileName:i,info:c}}else p={eventType:s,fileName:i,info:c},delete D[i];else p={eventType:s,fileName:i,info:c};this.postMessage("webframe","FILE_CHANGE",p,{})}},componentWillReceiveProps:function(e){"edit"===e.show?this._windowFocus():this._windowBlur()},render:function(){var e=this.props,t=e.show,r=(e.project,"edit"===t?{}:p.displayNone);return c.createElement("div",{className:"edit",ref:"container",style:r})}});_exports=C}var _exports;init(),module.exports=_exports;