"use strict";function init(){function e(e){return e.replace(/\\/g,"/")}function t(e){return{mtime:+e.mtime,birthtime:+e.birthtime,isDir:e.isDirectory(),size:e.size}}function r(e){try{return i.lstatSync(e)}catch(e){return{isDirectory:function(){return!1}}}}var s=require("glob"),i=require("fs"),o=require("path"),n=require("url"),a=require("rmdir"),c=require("../../lib/react.js"),p=require("../../cssStr/cssStr.js"),h=(require("../../actions/webviewActions.js"),require("../../actions/windowActions.js")),u=require("../../stores/windowStores.js"),d=(require("../../actions/projectActions.js"),require("../../weapp/utils/tools.js")),f=require("../../weapp/utils/projectManager.js"),l=require("../../stores/projectStores.js"),m=require("../../common/log/log.js"),w=require("child_process"),v=w.spawn,E=(w.spawnSync,w.exec,require("./utils/editTools.js")),_=require("./utils/grep.js"),g=require("./utils/formatCode.js"),R={},S=!1,b=("win32"===process.platform,{".jpg":!0,".png":!0,".jpeg":!0,".icon":!0,".gif":!0,".svg":!0}),j=function(e){h.showTipsMsg({msg:e,type:"error"})},N=function(e,t){h.showConfirm({content:e,callback:t})},T=c.createClass({displayName:"Edit",getInitialState:function(){return{project:this.props.project}},onMessage:function(c){var p=this,h=c.command,u=c.msg,m=c.ext,w=this.state.project;switch(h){case"GET_FILE_LIST":if(S)return;S=!0;var j=u.options,N=j.ignore||["node_modules/**/*","node_modules"];s("**",{cwd:w.projectpath,ignore:N,nosort:!0,strict:!1,silent:!0},function(e,s){S=!1;for(var i={ret:e?e.toString():0,res:{files:e?[]:s,info:{}}},n=0;n<s.length;n++){var a=s[n],c=o.join(w.projectpath,a),h=r(c),u=h.isDirectory();u&&(s[n]=a+"/"),i.res.info[s[n]]=t(h)}s.forEach(function(e){R[e]=!0}),p.postMessage("webframe","RETURN_RES",i,m)});break;case"GET_FILE_DATA":var T=u.path,y=o.extname(T);if(b[y]){var W="";try{W=decodeURI(n.resolve(d.getBaseURL(w),T))}catch(e){W=n.resolve(d.getBaseURL(w),T)}this.postMessage("webframe","RETURN_RES",{ret:0,res:{data:W}},m)}else{var I=o.join(w.projectpath,T);i.readFile(I,"utf8",function(e,s){var i=r(I),o=t(i),n={ret:e?e.toString():0,res:{data:e?"":s,info:o}};p.postMessage("webframe","RETURN_RES",n,m)})}break;case"SAVE_FILE_DATA":var M=o.join(w.projectpath,u.path),L=u.data,D=void 0;try{i.writeFileSync(M,L,"utf8");var F=i.lstatSync(M),O=+F.mtime;if(R[e(u.path)]=O,D={ret:0,res:{path:u.path,info:t(F)}},"app.json"===u.path)try{var U=JSON.parse(L),A=U.pages||[];E.initPage(w,A)}catch(e){}}catch(e){D={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",D,m);break;case"DEL_FILE":var C=u.path,P=void 0;try{i.unlinkSync(o.join(w.projectpath,C)),C=e(C),P={ret:0,res:C},delete R[C]}catch(e){P={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",P,m);break;case"RENAME_FILE":var k=o.join(w.projectpath,u.oldPath),q=o.join(w.projectpath,u.newPath),B=void 0,H=r(k);if(H.isDirectory()){f.manager.stopWatch();var x="darwin"===process.platform?"mv":"ren",G="darwin"===process.platform?['"'+k+'"','"'+q+'"']:['"'+k+'"','"'+o.relative(o.dirname(q),q)+'"'],J=[],Q=[],V=v(x,G,{shell:!0});V.on("close",function(e){f.manager.restartWatch(),B=0===e?{ret:0,res:{path:u.newPath,info:t(H)}}:{ret:"目录修改错误",res:""},p.postMessage("webframe","RETURN_RES",B,m)}),V.stdout.on("data",function(e){J.push(e)}),V.stderr.on("data",function(e){Q.push(e)})}else{try{i.renameSync(k,q),delete R[e(u.oldPath)];var z=i.lstatSync(q);R[u.newPath]=!0,B={ret:0,res:{path:u.newPath,info:t(z)}}}catch(e){B={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",B,m)}break;case"RM_DIR":var K=w.projectpath,X=o.join(K,u.path);a(X,function(t,r,s){t||(r.forEach(function(t){var r=o.relative(K,t);r=e(r),delete R[r]}),s.forEach(function(t){var r=o.relative(K,t);r=e(r),delete R[r]}));var i={ret:t?t.toString():0,res:t?"":r};p.postMessage("webframe","RETURN_RES",i,m)});break;case"ADD_FILE":var Y=o.join(w.projectpath,u.path),Z=i.existsSync(Y),$=void 0;if(Z)$={ret:u.path+" already existed"},this.postMessage("webframe","RETURN_RES",$,m);else{try{i.writeFileSync(Y,"","utf8"),R[e(u.path)]=!0;var ee=i.lstatSync(Y);$={ret:0,res:{path:u.path,info:t(ee)}}}catch(e){$={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",$,m)}break;case"MAKE_DIR":var te=o.join(w.projectpath,u.path),re=void 0;try{i.mkdirSync(te),R[e(u.path)]=!0;var se=i.lstatSync(te);re={ret:0,res:{path:te,info:t(se)}}}catch(e){re={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",re,m);break;case"GET_PROJECT_INFO":this.postMessage("webframe","RETURN_RES",{ret:0,res:w},m);break;case"SET_EDIT_WEBVIEW":var ie=u.editWebview;l.setProjectEditWebview(w.hash,ie),this.postMessage("webframe","RETURN_RES",{ret:0,res:ie},m);break;case"FIND_STR":var oe=u.options,ne=u.str,ae=oe.cwd,ce=oe.i,pe=oe.wholeword;ae=o.join(w.projectpath,ae),_({str:ne,cwd:ae,i:ce,wholeword:pe,project:w},function(e,t){var r={};e?r.ret=JSON.stringify(e):(r.ret=0,r.res=t),p.postMessage("webframe","RETURN_RES",r,m)});break;case"SHOW_ITEM_IN_FOLDER":var he=o.join(w.projectpath,u.filePath);nw.Shell.showItemInFolder(he);break;case"FORMAT_CODE":var ue=u.code,de=u.options;g(ue,de,function(e,t){var r={ret:0,res:t};p.postMessage("webframe","RETURN_RES",r,m)})}},postMessage:function(e,t,r,s){var i=this,o={to:e,msg:r,command:t,ext:s};return this.port?(this.msgQuery.length&&(this.msgQuery.forEach(function(e){i.port.postMessage(e)}),this.msgQuery=[]),void this.port.postMessage(o)):void this.msgQuery.push(o)},initport:function(e){var t=this;"edit"===e.name&&(this.port=e,this.port.onMessage.addListener(this.onMessage),this.port.onDisconnect.addListener(function(){t.port.onMessage.removeListener(t.onMessage),delete t.port,delete t.portID,t.msgQuery=[]}),this.postMessage("contentscript","SHAKE_HANDS",{}))},initRuntime:function(){chrome.runtime.onConnect.addListener(this.initport)},addContentScripts:function(){this.webview.addContentScripts([{name:"contentscript",matches:["<all_urls>"],js:{files:["app/dist/contentscript/editcontent.js"]},run_at:"document_start"}])},ewWindow:function(){this.webview.addEventListener("newwindow",function(e){var t=e.targetUrl;t&&nw.Window.open(t,{width:799,height:799})})},_windowFocus:function(){var e=this;if("focus"!==this.currentStatus){var t={eventType:"focus"};this.postMessage("webframe","WINDOW_CHANGE",t,{}),setTimeout(function(){e.webview.focus()},100),this.currentStatus="focus"}},_windowBlur:function(){if("blur"!==this.currentStatus){var e={eventType:"blur"};this.postMessage("webframe","WINDOW_CHANGE",e,{}),this.currentStatus="blur"}},_editWebview:function(e,t){e.hash===this.props.project.hash&&this.postMessage("webframe","WEBVIEW_SHOW_CHANGE",{editWebview:t},{})},_openProjectFile:function(e){this.postMessage("webframe","OPEN_FILE",e,{})},componentDidMount:function(){this.msgQuery=[],this.show=this.props.show;var e=this.refs.container,t=this.webview=document.createElement("webview");t.className="simulator-bd-webview_body",t.setAttribute("partition","persist:trusted"),t.setUserAgentOverride(t.getUserAgent()+" devtoolsedit"),e.appendChild(t),this.ewWindow(),this.addContentScripts(),this.initRuntime(),t.addEventListener("dialog",function(e){var t=e.messageType||"",r=e.messageText,s=e.dialog;if("alert"===t)j(r);else if("confirm"===t)e.preventDefault(),N(r,function(e){e?s.ok():s.cancel()});else if("prompt"===t){var i=prompt(r);null!==i?s.ok(i):s.cancel()}}),t.addEventListener("blur",function(e){h.editorBlur()}),t.addEventListener("focus",function(e){h.editorFocus()});var r=f.manager;r.on("FILE_CHANGE",this._initWatcher),t.src="app/html/edit.html",u.on("WINDOW_BLUR",this._windowFocus),u.on("WINDOW_FOCUS",this._windowBlur),l.on("PROJECT_STORES_CHANGE_EDIT_WEBVIEW",this._editWebview),u.on("OPEN_PROJECT_FILE",this._openProjectFile)},componentWillUnmount:function(){chrome.runtime.onConnect.removeListener(this.initport),u.removeListener("WINDOW_BLUR",this._windowFocus),u.removeListener("WINDOW_FOCUS",this._windowBlur),l.removeListener("PROJECT_STORES_CHANGE_EDIT_WEBVIEW",this._editWebview),u.removeListener("OPEN_PROJECT_FILE",this._openProjectFile);var e=f.manager;e.removeListener("FILE_CHANGE",this._initWatcher),this.webview.remove(),R={}},_initWatcher:function(r,s,i,n){if(r.hash===this.state.project.hash){var a=n?+n.mtime:0,c=n?t(n):{},p={};i=e(i);var h=(o.join(r.projectpath,i),R[i]);if("unlinkDir"===s&&(h=R[i+"/"]),"add"!==s&&"addDir"!==s||h)if("unlink"!==s&&"unlinkDir"!==s||!h){if("change"!==s)return void m.info("edit.js watch "+s);if(R[i]===a)return;R[i]=a,p={eventType:s,fileName:i,info:c}}else p={eventType:s,fileName:i,info:c},delete R[i];else p={eventType:s,fileName:i,info:c};this.postMessage("webframe","FILE_CHANGE",p,{})}},componentWillReceiveProps:function(e){"edit"===e.show?this._windowFocus():this._windowBlur()},render:function(){var e=this.props,t=e.show,r=(e.project,"edit"===t?{}:p.displayNone);return c.createElement("div",{className:"edit",ref:"container",style:r})}});_exports=T}var _exports;init(),module.exports=_exports;