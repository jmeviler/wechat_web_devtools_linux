"use strict";function init(){var e=require("../../lib/react.js"),t=require("../../cssStr/cssStr.js"),s=require("../../stores/windowStores.js"),a=require("../../stores/projectStores.js"),i=(require("../../actions/windowActions.js"),require("../../actions/webviewActions.js")),o=1,r=2,n=3,c=4,u=5,d=" ",l=e.createClass({displayName:"Music",getInitialState:function(){return{showPlayer:!1,musicState:o,title:d}},_initMusic:function(){var e=this,t=document.createElement("audio");document.body.appendChild(t),this.audio=t,t.addEventListener("play",function(){e.setState({musicState:r}),i.postMessageToAS({eventName:"onMusicPlay",type:"ON_MUSIC_EVENT",data:{dataUrl:t.src}})}),t.addEventListener("pause",function(){e.audio&&!e.audio.ended&&(e.audio.error||e.setState({musicState:n}),i.postMessageToAS({eventName:"onMusicPause",type:"ON_MUSIC_EVENT",data:{dataUrl:t.src}}))}),t.addEventListener("ended",function(){e.setState({musicState:c}),i.postMessageToAS({eventName:"onMusicEnd",type:"ON_MUSIC_EVENT",data:{dataUrl:t.src}})}),t.addEventListener("error",function(s){e.setState({musicState:u}),i.postMessageToAS({eventName:"onMusicError",type:"ON_MUSIC_EVENT",data:{dataUrl:t.src,errMsg:"Error: "+t.error.code}})})},_play:function(e){this.audio||this._initMusic();var t=this.audio;e.dataUrl&&e.dataUrl!==t.src?(t.src=e.dataUrl,t.play(),t.currentTime=0):t.src&&t.play(),this.setState({title:e.title||d})},_resume:function(e){var t=this.audio;t.paused&&t.play()},_pause:function(e){var t=this.audio;t.paused||t.pause()},_seek:function(e){var t=this.audio;t.paused||(t.currentTime=1*e.position)},_stop:function(){if(this.audio){var e=this.audio.src;setTimeout(function(){i.postMessageToAS({eventName:"onMusicEnd",type:"ON_MUSIC_EVENT",data:{dataUrl:e}})}),this.audio.remove(),this.audio=void 0}this.setState({musicState:c})},_getMusicPlayState:function(e){var t=this.audio,s=void 0;if(t)try{s={dataUrl:t.src,duration:Math.floor(t.duration),currentPosition:Math.floor(t.currentTime),status:t.paused?0:1,downloadPercent:Math.round(100*t.buffered.end(0)/t.duration)}}catch(e){s={status:2}}else s={status:2};return e&&e(s),s},_operateMusicPlayer:function(e){"play"==e.operationType?(this._play(e),this.setState({showPlayer:!0})):"resume"==e.operationType?this._resume(e):"pause"==e.operationType?this._pause(e):"seek"==e.operationType?this._seek(e):"stop"==e.operationType&&this._stop(e)},componentDidMount:function(){s.on("GET_MUSIC_PLAY_STATE",this._getMusicPlayState),s.on("BODY_CLICK",this._bodyClick),s.on("OPERATE_MUSIC_PLAY",this._operateMusicPlayer),a.on("RESTART_PROJECT",this._stop),a.on("CLOSE_PROJECT",this._stop)},componentWillUnmount:function(){s.removeListener("GET_MUSIC_PLAY_STATE",this._getMusicPlayState),s.removeListener("BODY_CLICK",this._bodyClick),s.removeListener("OPERATE_MUSIC_PLAY",this._operateMusicPlayer),a.removeListener("RESTART_PROJECT",this._stop),a.removeListener("CLOSE_PROJECT",this._stop),this.audio&&this.audio.remove()},_bodyClick:function(e){this.setState({showPlayer:!1})},stop:function(e){this._stop()},_showOrHide:function(e){this.setState({showPlayer:!this.state.showPlayer}),e.stopPropagation(),e.preventDefault()},_playOrPause:function(e){this.state.musicState==n?this._resume():this._pause(),e.stopPropagation(),e.preventDefault()},render:function(){var s=this.state.musicState==r||this.state.musicState==n?{}:t.displayNone,a=this.state.showPlayer?{}:t.displayNone,i=this.state.musicState==n?{}:t.displayNone,o=this.state.musicState==r?{}:t.displayNone;return e.createElement("div",{style:s,title:"音乐控件",onClick:this._showOrHide,className:"sidebar-item"},e.createElement("i",{className:"sidebar-item-icon  sidebar-item-icon-music"}),e.createElement("label",{className:"sidebar-item-label"},"音乐"),e.createElement("div",{className:"music-card",style:a,onClick:this._playOrPause},e.createElement("div",{className:"music-card-main"},e.createElement("p",{className:"music-card-status"},"正在播放"),e.createElement("p",{className:"music-card-name"},this.state.title)),e.createElement("div",{className:"music-card-opr"},e.createElement("i",{className:"music-card-play-icon",style:i}),e.createElement("i",{className:"music-card-pause-icon",style:o}))))}});_exports=l}var _exports;init(),module.exports=_exports;