"use strict";function init(){function e(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"alert";s.showConfirm({content:e,type:t})}function t(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success";s.showTipsMsg({msg:e,type:t})}var r=require("../../lib/react.js"),o=require("../../cssStr/cssStr.js"),i=require("../../stores/windowStores.js"),s=require("../../actions/windowActions.js"),n=require("../../actions/webviewActions.js"),a=require("../../stores/projectStores.js"),c=require("../../weapp/utils/projectManager.js"),l=require("../../config/dirConfig.js"),p=require("../../common/request/request.js"),u=require("../../common/log/log.js"),d=require("glob"),h=require("path"),f=require("fs"),m=require("../../config/urlConfig.js"),g=m.cleanUserAuth,v=m.clearUserAutoFillInfo,j=require("../../config/errcodeConfig.js"),A=j.DEV_PLATFORM_INVALID_EXT_APPID,S=j.DEV_PLATFORM_EXT_APPID_NOT_AUTH,_=r.createClass({displayName:"Cache",getInitialState:function(){return{show:!1}},clickOpen:function(e){e.stopPropagation(),this.setState({show:!0})},componentDidMount:function(){i.on("BODY_CLICK",this._onBodyClick)},componentWillUnmount:function(){i.removeListener("BODY_CLICK",this._onBodyClick)},_onBodyClick:function(){this.close()},clearStorage:function(e){var r=this;e.stopPropagation();var o=i.getUserInfo(),s=o?o.openid:"unknow",c=l.WeappStorage,p=this.props.project,u=p.appid,d=p.appname,m=h.join(c,u+"_"+d+"_"+s+".data.json");f.unlink(m,function(e){t("清除数据存储成功"),r.close(),n.upASData(u,{}),a.setProjectLocalStorage(p.hash,{})})},clearFileStorage:function(e){var r=this;e.stopPropagation();var o=i.getUserInfo(),s=o?o.openid:"unknow",n=l.WeappFileCache,a=this.props.project,c=a.hash;d("*",{cwd:n},function(e,o){var i=""+c+s;o.forEach(function(e){if(e.indexOf(i)>-1){var t=h.join(n,e);f.unlink(t)}}),r.close(),t("清除文件存储成功")})},clearSdkUserAuthStorage:function(e){e.stopPropagation(),a.setUserAuthPemissionStorage(this.props.project,{}),t("清除授权数据成功"),this.close()},clearCloudAuth:function(r){var o=this;r.stopPropagation();var i=this.props.project,s=c.getExtAppId(i),n=2,a=[],l=function(r){n--,r&&a.push(r),0==n&&(0==a.length?t("清除工具及手机授权数据成功"):e(a.join(",")),o.close())};p({method:"post",url:g+"?appid="+i.appid+"&ext_appid="+s+"&platform="+(i.platform?1:0),needToken:1},function(e,t,r){var o=null;if(e)o=""+e,u.error("cache.js clearSdkUserAuthStorage error: "+e);else if(r=JSON.parse(r),r.baseresponse){var i=r.baseresponse.errcode;0==i||(o=i==A?"无效的 extAppID":i==S?"extAppID 未授权":""+i)}o=o?"清除后台授权数据失败:"+o:null,l(o)}),p({method:"post",url:v+"?appid="+i.appid+"&ext_appid="+s+"&platform="+(i.platform?1:0),needToken:1},function(e,t,r){var o=null;if(e)o=""+e,u.error("cache.js clearUserAutoFillInfo error: "+e.toString());else if(r=JSON.parse(r),r.baseresponse){var i=r.baseresponse.errcode;if(0==i);else if(i==A)o="无效的 extAppID";else{if(i==S)return void(o="extAppID 未授权");o=""+i}}o=o?"清除用户自动填充表单数据失败:"+o:null,l(o)})},close:function(){this.setState({show:!1})},render:function(){var e=this.state.show?o.displayBlock:o.displayNone;return r.createElement("div",{onClick:this.clickOpen,title:"清除缓存",className:"sidebar-item"},r.createElement("i",{className:"sidebar-item-icon sidebar-item-icon-cache"}),r.createElement("label",{className:"sidebar-item-label"},"缓存"),r.createElement("div",{className:"cache-card",style:e},r.createElement("div",{className:"cache-card-item",onClick:this.clearStorage},r.createElement("p",null,"清除数据存储")),r.createElement("div",{className:"cache-card-item",onClick:this.clearFileStorage},r.createElement("p",null,"清除文件存储")),r.createElement("div",{style:this.props.project.isTourist?o.displayNone:{},className:"cache-card-item",onClick:this.clearCloudAuth},r.createElement("p",null,"清除授权数据"))))}});_exports=_}var _exports;init(),module.exports=_exports;