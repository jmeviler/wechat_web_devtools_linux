"use strict";function init(){var e,t=require("../../lib/react.js"),s=(require("../../lib/react-dom.js"),require("../../cssStr/cssStr.js")),o=require("../../stores/webviewStores.js"),r=require("../../stores/windowStores.js"),i=require("../../actions/webviewActions.js"),n=require("../../stores/projectStores.js"),a=require("../../actions/projectActions.js"),p=require("../../weapp/utils/tools.js"),c=require("./../../common/log/log.js"),d=require("../../common/assdk/asSdk.js"),h=require("../../debugger/debugger.js"),u=require("../../config/dirConfig.js"),_=require("../../actions/windowActions.js"),v=require("./console/showconsole.js"),g=require("../../config/config.js"),l=require("./port/port.js"),m=1e5,E=1e6,S="about:blank",f={},w=function(e,t){_.showConfirm({content:e,callback:t})},A=t.createClass({displayName:"DevTools",getInitialState:function(){var e=o.getNetworkType();return{isWxml:!1,networkType:e}},addContentScripts:function(e){e.addContentScripts([{name:"contentScripts",matches:["<all_urls>"],js:{files:["app/dist/contentscript/contentScript.js"]},run_at:"document_start"}])},_initport:function(e){var t=e.name;if(t==="webview"+m)this.port.init(e),this.port.postMessage("contentscript",{},"SHAKE_HANDS");else if(t==="webview"+E){if(this.devtoolsview.src===S)return;this.devtoolsPort.init(e),this.devtoolsPort.postMessage("contentscript",{},"SHAKE_HANDS")}},_externalPort:function(e){var t=this,s=e.name;"storage"===s?(this.storagePort.init(e),this.storagePort.postMessage("",{},"SHAKE_HANDS")):"appdata"===s?(this.appdataPort.init(e),this.appdataPort.postMessage("",{},"SHAKE_HANDS")):"wxml"===s?(this.wxmlPort.init(e),this.wxmlPort.postMessage("",{},"SHAKE_HANDS"),this.state.isWxml&&setTimeout(function(){t.wxmlPort.postMessage("",{},"SET_INSPECT_MODE")},200)):"bluetooth"===s?(this.bluetoothPort.init(e),this.bluetoothPort.postMessage("",{},"SHAKE_HANDS")):"sensor"===s&&(this.sensorPort.init(e),this.sensorPort.postMessage("",{},"SHAKE_HANDS"))},initRuntime:function(){chrome.runtime.onConnect.addListener(this._initport)},storageMessage:function(e){if("GET_APP_DATA"===e.command){var t={storage:p.getProjectStorage(this.props.project)};this.storagePort.postMessage("",t,"tabui-setAsData")}},sensorMessage:function(e){if("GET_SENSOR_STATUS"===e.command){var t=r.getSensorStatus();this._onSensorStatusChange(t)}},wxmlMessage:function(e){var t=this,s=e.command,r=e.ext,i=e.data;if("GET_CURRENT_DEBUGGEE"===s){var n=o.getCurrentWebviewID(),a=this.debuggeeMap[n];if(!a)return void c.error("appservice.js error do not find "+n+" debuggee");this.wxmlPort.postMessage("",{res:{debuggee:a},ext:r,args:i},"GET_CURRENT_DEBUGGEE")}else"SEND_COMMAND"===s?("DOM.setInspectMode"===i.method&&"none"===i.commandParams.mode&&this.setState({isWxml:!1}),h.sendCommand(i.debuggee,i.method,i.commandParams,function(e){t.wxmlPort.postMessage("",{res:e,ext:r,args:i},"GET_DEVTOOLS_RES")})):"OPEN_FILE"===s&&_.openProjectFile(i)},appdataMessage:function(e){var t=e.command;"GET_APP_DATA"===t?this.port.postMessage("appservice",{},"GET_APP_DATA"):"WRITE_APP_DATA"===t&&this.port.postMessage("appservice",e.data,"WRITE_APP_DATA")},bluetoothMessage:function(e){e.command},onMessage:function(e){var t=this;if("COMMAND_FROM_ASJS"===e.command){var s=e.sdkName;if("__open-tools-log"===s)return void nw.Shell.openItem(u.WeappLog);if("__open-tools-vendor"===s)return void nw.Shell.openItem(u.WeappVendor);if("APP_SERVICE_COMPLETE"===s)return void o.emit("APPSERVICE_INIT");if("send_app_data"===s)return void this.appdataPort.postMessage("",e,"SEND_APP_DATA");if("publish"===s)return void i.asPublish(e);if("__show-new-feature-check"===s)return void _.toggleNewFeatureCheckShowStatus(!0);if("__hhdmbadmb"===s){var r=require("path"),a=require("fs"),p=r.join(__dirname,"../../../html/ext.html");if(!a.existsSync(p))return;return void nw.Window.open("app/html/ext.html",{show:!0,width:1219,height:1219},function(e){})}"__show-sys-info"===s&&chrome.processes.getProcessInfo([],!0,function(e){var s=0,o=[];for(var r in e){var i=e[r];i.privateMemory&&(s+=i.privateMemory),o.push({osProcessId:i.osProcessId,type:i.type,privateMemory:i.privateMemory/1024/1024})}s=s/1024/1024;var a=n.getRestartInfo();t.port.postMessage("contentscript",{memory:s,restartInfo:a,info:o},"SHOW_SYS_INFO")}),d.exec(e,function(s,o){setTimeout(function(){t.port.postMessage("appservice",s,"GET_ASSDK_RES",e)},0)})}},initExternal:function(){chrome.runtime.onConnectExternal.addListener(this._externalPort)},newWindow:function(e){e.addEventListener("newwindow",function(e){var t=e.targetUrl;t&&("https://developers.google.com/web/tools/chrome-devtools/"===t&&(t="https://mp.weixin.qq.com/debug/wxadoc/dev/index.html"),nw.Window.open(t,{width:799,height:799}))})},_initAppservice:function(){function e(){function t(){s.removeEventListener("loadcommit",t),s.showDevTools(!0,r)}r.removeEventListener("loadcommit",e),s.addEventListener("loadcommit",t),s.src="http://"+n.hash+".appservice.open.weixin.qq.com/appservice"}var t=this.refs.container,s=this.appserviceWebview=document.createElement("webview");s.style.cssText="height:0.01px;width:0.01px";var o=s.getUserAgent();s.setUserAgentOverride(o+" appservice webview/"+m),t.appendChild(s),this.addContentScripts(s);var r=this.devtoolsview=document.createElement("webview");r.className="devtools-content";var i=r.getUserAgent()+" asviewdevtools webview/"+E+" chromeRuntimeID/"+chrome.runtime.id;r.setUserAgentOverride(i),r.setAttribute("partition","persist:trusted"),t.appendChild(r),this.addContentScripts(r),this.newWindow(r);var n=this.props.project;r.addEventListener("loadcommit",e),r.src=S,this.initRuntime(),this.initExternal(),this.onHeadersReceived(),this.onBeforeSendHeaders(),this.onErrorOccurred(),this.onSyncMessage(),this.onSyncDevtoolsMessage()},_postMsgToAS:function(e){this.port.postMessage("appservice",e,"MSG_FROM_WEBVIEW")},_upASData:function(e,t){var s={storage:t};this.storagePort.postMessage("",s,"tabui-setAsData")},_upASBluetoothData:function(e,t){var s={bluetooth:t};this.bluetoothPort.postMessage("",s,"bluetooth-update")},_restart:function(){var e=this,t=this.props.project,s="http://"+t.hash+".appservice.open.weixin.qq.com/appservice";t.ext_appid?n.setProjectExtAppInfo(t,function(t){t||(e.appserviceWebview.src=s)}):this.appserviceWebview.src=s},_startDebuggee:function(e,t){var s=this,r=t.webview,n=t.webviewOffset;new Date;h.start(r,{webviewOffset:n},function(t){s.debuggeeMap[e]=t,s.wxmlPort.postMessage("",{debuggee:t},"CHANGE_DEBUGGEE"),i.touchSetSuc(e)},function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("DOM.inspectNodeRequested"===t&&s.setState({isWxml:!1}),"DOM.inlineStyleInvalidated"!==t&&"DOM.characterDataModified"!==t&&("DOM.nodeHighlightRequested"!==t||"DOM.nodeHighlightRequested"!==f.method||r.nodeId!==f.nodeId)){f="DOM.nodeHighlightRequested"===t?{method:t,nodeId:r.nodeId}:{};var i=o.getOffset();s.wxmlPort.postMessage("",{debuggee:e,method:t,params:r,offset:i},"ON_EVENT")}},function(e,t){s.wxmlPort.postMessage("",{debuggee:e},"ON_DETACH");for(var o in s.debuggeeMap)if(s.debuggeeMap[o].targetId===e.targetId)return void delete s.debuggeeMap[o]})},_changeWebview:function(e){var t=this.debuggeeMap[e];t&&this.wxmlPort.postMessage("",{debuggee:t},"CHANGE_DEBUGGEE")},_setWebviewInfo:function(e){for(var t in this.debuggeeMap)h.sendCommand(this.debuggeeMap[t],"Emulation.setDeviceMetricsOverride",{width:parseInt(e.width),height:parseInt(e.height),deviceScaleFactor:e.dpr,mobile:!0,fitWindow:!1})},_getWeappError:function(e,t,s){this.port.postMessage("appservice",{fileName:p.getFileNameFromUrl(t),errStr:s},"WINDOW_GET_WEBAPP_ERROR")},inspector:function(){return this.wxmlPort.hasInit?(this.setState({isWxml:!0}),void this.wxmlPort.postMessage("",{},"SET_INSPECT_MODE")):void _.showTipsMsg({msg:"请先切换至 Wxml Pannel",type:"error"})},onSyncDevtoolsMessage:function(){var e=this.devtoolsview;e.addEventListener("dialog",function(e){var t=e.messageType||"",s=e.messageText;if("prompt"===t){var r=/^____sdk____/.test(s);if(r){var i=JSON.parse(s.replace(/^____sdk____/,"")),n=i.command;if("GET_GEO_SETTING"===n){var a=o.getGeoSetting();e.dialog.ok(JSON.stringify(a))}else"SET_GEO_SETTING"===n&&o.setGeoSetting(i.geoSetting)}}})},onSyncMessage:function(){var e=this.appserviceWebview;e.addEventListener("dialog",function(e){var t=e.messageType||"",s=e.messageText;if("prompt"===t){e.preventDefault();var o=/^____sdk____/.test(s);if(o){var r=JSON.parse(s.replace(/^____sdk____/,"")),n=r.command;if("COMMAND_FROM_ASJS"===n){var a=r.sdkName;d.exec(r,function(t,s){var o={to:"appservice",msg:t,command:"GET_ASSDK_RES",ext:r};e.dialog.ok(JSON.stringify(o)),!s||"setStorageSync"!==a&&"clearStorageSync"!==a||i.upASData(s.appid,s.storage)})}}}else if("confirm"===t){e.preventDefault();var p=e.dialog;w(s,function(e){e?p.ok():p.cancel()})}})},onBeforeSendHeaders:function(){var t=this,s=this.appserviceWebview,o=s.request,r=this.props.project;o.onBeforeSendHeaders.addListener(function(s){var o=s.url;if("main_frame"===s.type&&o.match(/\?load$/))return clearTimeout(e),e=setTimeout(function(){a.restart(t.props.project)},500),{cancel:!0};if(0!=o.indexOf("http://"+r.hash+".appservice.open.weixin.qq.com")&&"none"==t.state.networkType)return t.appserviceWebview.executeScript({code:'console.group("'+new Date+' 无网络状态模拟")\n                console.debug(`已开启无网络状态模拟，网络请求已被阻止；在工具栏切换网络状态，可恢复网络请求。`)\n                console.groupEnd()'}),{cancel:!0};var i=s.requestHeaders||[],n=i.findIndex(function(e){return"cookie"===e.name.toLowerCase()});i.splice(n,1);for(var p=0;p<i.length;++p)"_Cookie"===i[p].name&&(i[p].name="Cookie"),"Referer"===i[p].name&&(i[p].value="https://servicewechat.com/"+r.appid+"/devtools/page-frame.html");return{requestHeaders:s.requestHeaders}},{urls:["<all_urls>"]},["blocking","requestHeaders"])},onHeadersReceived:function(){var e=this,t=this.appserviceWebview,s=t.request;s.onHeadersReceived.addListener(function(t){var s=t.type;if("script"===s){var o=t.responseHeaders||[],r=o.find(function(e){return e.name===g.ES6_ERROR});r&&e._showWeappError(g.ES6_ERROR,r.value)}},{urls:["<all_urls>"]},["blocking","responseHeaders"])},onErrorOccurred:function(){var e=this,t=this.appserviceWebview,s=t.request;s.onErrorOccurred.addListener(function(t){var s=t.type;if("main_frame"===s&&0===t.error.indexOf("net::")&&"net::ERR_BLOCKED_BY_CLIENT"!==t.error)return void e.port.postMessage("contentscript",t,"ERR_CONNECTION_RESET")},{urls:["<all_urls>"]})},_showWeappError:function(e,t){var s=this;if("edit"===this.props.propshow&&/ERROR\:?$/.test(e)&&e!==g.WEBVIEW_ERROR&&setTimeout(function(){_.showTipsMsg({msg:"编译出现错误，请去控制台查看详细信息",type:"error"})},17),0===e.indexOf("JSON"))return void v(this.appserviceWebview,e,t);if(/\?load$/.test(this.appserviceWebview.src))return void v(this.appserviceWebview,e,t);var o=0,r=setInterval(function(){var i=s.appserviceWebview.src||"";/\?load$/.test(i)?(v(s.appserviceWebview,e,t),clearInterval(r)):(o++,20===o&&clearInterval(r))},500)},_onSimulatorNetworkChange:function(e){this.setState({networkType:e})},_onSensorStatusChange:function(e){this.sensorPort&&this.sensorPort.postMessage("",e,"SET_SENSOR_STATUS")},componentDidMount:function(){this.port=new l({onMessage:this.onMessage}),this.devtoolsPort=new l,this.storagePort=new l({onMessage:this.storageMessage}),this.wxmlPort=new l({onMessage:this.wxmlMessage}),this.appdataPort=new l({onMessage:this.appdataMessage}),this.bluetoothPort=new l({onMessage:this.bluetoothMessage}),this.sensorPort=new l({onMessage:this.sensorMessage}),this.debuggeeMap={},this._initAppservice(),o.on("POST_MSG_TOAS",this._postMsgToAS),o.on("UP_AS_DATA",this._upASData),o.on("UP_BL_DATA",this._upASBluetoothData),n.on("RESTART_PROJECT",this._restart),r.on("START_WEBVIEW_DEBUGGEE",this._startDebuggee),r.on("WINDOW_CHANGE_WEBVIEW_ID",this._changeWebview),r.on("SET_WEBVIEW_INFO",this._setWebviewInfo),r.on("WINDOW_GET_WEBAPP_ERROR",this._getWeappError),r.on("WINDOW_SHOW_WEBAPP_ERROR",this._showWeappError),r.on("SENSOR_STATUS_CHANGE",this._onSensorStatusChange),o.on("SIMULATOR_NETWORK_CHANGE",this._onSimulatorNetworkChange)},componentWillUnmount:function(){this.devtoolsview.remove(),this.appserviceWebview.remove(),o.removeListener("POST_MSG_TOAS",this._postMsgToAS),o.removeListener("UP_AS_DATA",this._upASData),o.removeListener("UP_BL_DATA",this._upASBluetoothData),n.removeListener("RESTART_PROJECT",this._restart),r.removeListener("START_WEBVIEW_DEBUGGEE",this._startDebuggee),r.removeListener("WINDOW_CHANGE_WEBVIEW_ID",this._changeWebview),r.removeListener("SET_WEBVIEW_INFO",this._setWebviewInfo),r.removeListener("WINDOW_GET_WEBAPP_ERROR",this._getWeappError),r.removeListener("WINDOW_SHOW_WEBAPP_ERROR",this._showWeappError),r.removeListener("SENSOR_STATUS_CHANGE",this._onSensorStatusChange),o.removeListener("SIMULATOR_NETWORK_CHANGE",this._onSimulatorNetworkChange),chrome.runtime.onConnectExternal.removeListener(this._externalPort),chrome.runtime.onConnect.removeListener(this._initport)},render:function(){var e="appservice"===this.props.show?{height:"100%"}:s.webviewDisplayNone;"edit"===this.props.propshow&&(e=s.webviewDisplayNone);var o="debug"===this.props.propshow?{}:s.displayNone,r=this.state.isWxml?"devtools-inspector devtools-inspector-active":"devtools-inspector";return t.createElement("div",{style:e,ref:"container",className:"devtools"},t.createElement("div",{className:"devtools-inspector-bg",style:o}),t.createElement("div",{style:o,onClick:this.inspector,className:r}))}});_exports=A}var _exports;init(),module.exports=_exports;