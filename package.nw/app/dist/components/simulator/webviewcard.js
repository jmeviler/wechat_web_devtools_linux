"use strict";function init(){var e=require("../../lib/react.js"),a=require("../../cssStr/cssStr.js"),t=require("../../stores/webviewStores.js"),r=require("../../actions/webviewActions.js"),c=(require("../../actions/leftviewActions.js"),require("../../stores/leftviewStores.js"),require("../../common/log/log.js")),i=require("../../common/jssdk/sdkNameTrans.js"),d=require("../../config/errcodeConfig.js"),s="https://mp.weixin.qq.com/debug/cgi-bin/webdebugger/acceptcarditem",m=e.createClass({displayName:"WebviewCard",getInitialState:function(){return{showDetails:!1}},cancel:function(){this.close();var e=this.props.cardInfo,a=e.data,t=e.webviewID,c=e.sdkName,d=e.isHavePurview;if("batchViewCard"!==c){var s={errMsg:i.getSdkDisplayName(c)+":cancel"},m={type:"CARD_SDK"};r.sendJSSDKRes(t,c,s,a.ext),r.setSdkLog(t,a,d,s,m)}},close:function(e){return this.state.showDetails?void this.setState({showDetails:!1}):void this.props.closeCard()},batchAddCard:function(e){for(var a=this,t=e.currentTarget,i=t.dataset,d=i.index,m=this.props.cardInfo,o=m.data,l=o.args,n=m.webviewID,v=m.sdkName,w=m.isHavePurview,b=l.appId,_=this.props.cardInfo.cardData[d],h=l.card_list[d],N=[],E=0;E<_.amount;E++)N.push({card_id:h.card_id,card_ext:h.card_ext,is_succ:1});var p=require("../../common/request/request.js"),u={appid:b,acceptitem_list:N,js_checinfo_url:o.ext.url},g={url:s,body:JSON.stringify(u),method:"post",needToken:!0},f={type:"CARD_SDK"};p(g,function(e,t,i){if(e){c.error("WebviewCards.js batchAddCard request error "+JSON.stringify(e));var d={errMsg:"addCard:fail; "+JSON.stringify(e)};r.sendJSSDKRes(n,v,d,o.ext),r.setSdkLog(n,o,w,d,f),a.close()}else{var s=JSON.parse(i),m=s.baseresponse;if(0===m.errcode){var l={errMsg:"addCard:ok",card_list:JSON.stringify(N)},b=N.map(function(e){return{cardExt:e.card_ext,cardId:e.card_id,isSuccess:!0}}),_={errMsg:"addCard:ok",cardList:b};r.sendJSSDKRes(n,v,l,o.ext),r.setSdkLog(n,o,w,_,f),a.close()}else{var h={errMsg:"addCard:fail; "+m.errmsg};r.sendJSSDKRes(n,v,h,o.ext),r.setSdkLog(n,o,w,h,f),a.close()}}})},chooseCard:function(e){var a=this.props.cardInfo,t=a.data,c=a.sdkName,i=a.webviewID,d=a.isHavePurview,s=e.currentTarget,m=s.dataset,o={type:"CARD_SDK"},l=[{card_id:m.cardid,encrypt_code:m.encryptcode}],n={errMsg:"chooseCard:ok",choose_card_info:JSON.stringify(l)};r.sendJSSDKRes(i,c,n,t.ext),r.setSdkLog(i,t,d,n,o),this.close()},formatTime:function(e){var a=new Date(1e3*e);return a.getFullYear()+"."+(a.getMonth()+1)+"."+a.getDate()},cardDetail:function(e){var a=e.currentTarget,t=a.dataset,r=t.index;this.setState({showDetails:!0,cardIndex:r})},render:function(){var r=this,c=this.props.showCard?{}:a.displayNone,i=t.getOffset();delete i.dpr,c=Object.assign({},c,i);var s=this.props.cardInfo,m=s.sdkName,o=s.cardData,l=e.createElement("div",null);if("batchAddCard"===m){var n={},v=o.map(function(a,t){if(a.errmsg)return e.createElement("div",{className:"webview-card-add-item",key:t},e.createElement("div",{className:"webview-card-add-item_top"},e.createElement("div",{className:"webview-card-add-item_details"},e.createElement("div",{className:"webview-card-add-item_name"},"cardId: ",a.card_id),e.createElement("div",{className:"webview-card-add-item_info"},e.createElement("span",{className:"webview-card-add-item_intro"},"errmsg: ",a.errmsg)))),e.createElement("div",{className:"webview-card-add-item_bottom webview-card-add-item_bottom_error"},e.createElement("div",{className:"webview-card-add-item_button"},"错误卡券")));var c=a.card_tp_info,i=c.brand_name,d=c.title,s=c.logo_url,m=a.card_data_info;n.backgroundColor=c.color;var o=r.formatTime(c.begin_time),l=r.formatTime(c.end_time),v=0===m.limit_num,w=void 0;return w=v?e.createElement("div",{className:"webview-card-add-item_bottom webview-card-add-item_bottom_disable",style:n},e.createElement("div",{className:"webview-card-add-item_button_error"},c.limit_wording)):e.createElement("div",{"data-index":t,onClick:r.batchAddCard,className:"webview-card-add-item_bottom",style:n},e.createElement("div",{className:"webview-card-add-item_button"},c.accept_wording)),e.createElement("div",{className:"webview-card-add-item",key:t},e.createElement("div",{className:"webview-card-add-item_top"},e.createElement("div",{className:"webview-card-add-item_left"},e.createElement("img",{className:"webview-card-add-item_img",src:s})),e.createElement("div",{className:"webview-card-add-item_details"},e.createElement("div",{className:"webview-card-add-item_name"},i),e.createElement("div",{className:"webview-card-add-item_info"},e.createElement("span",{className:"webview-card-add-item_intro"},d),e.createElement("span",{className:"webview-card-add-item_num"},"X",a.amount)),e.createElement("div",{className:"webview-card-add-item_time"},o," - ",l))),w)});l=e.createElement("div",{className:"webview-card-add",style:n},e.createElement("div",{className:"webview-card-add-header"},e.createElement("div",{className:"webview-card-add-header_button",onClick:this.cancel}," 取消 "),e.createElement("div",{className:"webview-card-add-header_title"}," 添加卡卷 ")),e.createElement("div",{className:"webview-card-add-container"},v))}else if("chooseCard"===m){var w=o.available_cards,b=w.map(function(a,t){return e.createElement("div",{onClick:r.chooseCard,key:t,"data-appid":a.app_id,"data-cardid":a.card_tp_id,"data-encryptcode":a.encrypt_code,className:"webview-card-choose-item"},e.createElement("div",{className:"webview-card-choose_m"},e.createElement("div",{className:"webview-card-choose_left"},e.createElement("img",{className:"webview-card-choose-item_img",src:a.logo_url})),e.createElement("div",{className:"webview-card-choose_details"},e.createElement("div",{className:"webview-card-choose-item_name"},a.sub_title),e.createElement("div",{className:"webview-card-choose-item_info"},a.title))))}),_=void 0;_=b.length?e.createElement("div",{className:"webview-card-choose-container",style:{height:i.height-42}},e.createElement("span",{className:"webview-card-choose-mycard"},"我的卡卷"),e.createElement("div",{className:"webview-card-choose-item"},b)):e.createElement("div",{className:"webview-card-choose-container",style:{height:i.height-42}},e.createElement("span",{className:"webview-card-choose-mycard webview-card-choose-mycardEmpty"},"暂无可添加的卡券")),l=e.createElement("div",{className:"webview-card-choose"},e.createElement("div",{className:"webview-card-choose-header"},e.createElement("div",{className:"webview-card-choose-header_button",onClick:this.cancel}," 取消 "),e.createElement("div",{className:"webview-card-choose-header_title"}," 选择卡卷 ")),_)}else if("batchViewCard"===m){var h=s.cardData.retData.card_array,N=s.cardData.errData,E=!!N.length,p=this.state.showDetails;if(1===h.length&&!E||p){var u=p?h[this.state.cardIndex]:h[0],g=u.card_data_info,f=this.formatTime(g.begin_time),y=this.formatTime(g.end_time),C=u.card_tp_info,D=C.brand_name,S=C.title,k=C.logo_url,x=0===C.limit_num,I=void 0,q={};q.backgroundColor=C.color,I=x?e.createElement("div",{className:"webview-card-add-item_bottom webview-card-add-item_bottom_disable"},e.createElement("div",{className:"webview-card-add-item_button_error"},C.limit_wording)):e.createElement("div",{onClick:this.batchAddCard,className:"webview-card-add-item_bottom"},e.createElement("div",{className:"webview-card-add-item_button"},C.accept_wording));var j=p?"返回":"关闭";l=e.createElement("div",{className:"webview-card-open",style:q},e.createElement("div",{className:"webview-card-open-header"},e.createElement("div",{className:"webview-card-open-header_button",onClick:this.cancel}," ",j," ")),e.createElement("div",{className:"webview-card-open-container"},e.createElement("div",{className:"webview-card-open_top"},e.createElement("img",{className:"webview-card-open-item_img",src:k})),e.createElement("div",{className:"webview-card-open_middle"},e.createElement("div",{className:"webview-card-open-name"},D),e.createElement("div",{className:"webview-card-open-intro"},S),e.createElement("div",{className:"webview-card-open-item_button",style:q},e.createElement("div",{className:"webview-card-open_buttom_wording"},"立即使用")),e.createElement("div",{className:"webview-card-open-time"},"有效期: ",f,"-",y)),e.createElement("div",{className:"webview-card-open_bottom"},e.createElement("div",{className:"webview-card-open_detail"},"兑换卷详情"),e.createElement("div",{className:"webview-card-open_detail"},"公众号"),e.createElement("div",{className:"webview-card-open_detail"},"在线兑换"))))}else{var A=h.map(function(a,t){var c=a.card_tp_info;return e.createElement("div",{onClick:r.cardDetail,key:t,"data-index":t,className:"webview-card-choose-item"},e.createElement("div",{className:"webview-card-choose_m"},e.createElement("div",{className:"webview-card-choose_left"},e.createElement("img",{className:"webview-card-choose-item_img",src:c.logo_url})),e.createElement("div",{className:"webview-card-choose_details"},e.createElement("div",{className:"webview-card-choose-item_name"},c.brand_name),e.createElement("div",{className:"webview-card-choose-item_info"},c.title))))}),J=N.map(function(a,t){var r="INVALID_CODE"===d[a.errcode]?"错误卡券 ID":"错误卡卷 code";return e.createElement("div",{key:t,className:"webview-card-choose-item"},e.createElement("div",{className:"webview-card-choose_mErr"},e.createElement("div",{className:"webview-card-choose_details"},e.createElement("div",{className:"webview-card-choose-item_error"},r),e.createElement("div",{className:"webview-card-choose-item_error"},"cardId: ",a.card_id),e.createElement("div",{className:"webview-card-choose-item_error"},"code: ",a.code))))});l=e.createElement("div",{className:"webview-card-choose"},e.createElement("div",{className:"webview-card-choose-header"},e.createElement("div",{className:"webview-card-choose-header_button",onClick:this.cancel}," 关闭 "),e.createElement("div",{className:"webview-card-choose-header_title"}," 卡券列表 ")),e.createElement("div",{className:"webview-card-choose-container",style:{height:i.height-42}},e.createElement("div",{className:"webview-card-choose-item"},A,J)))}}return e.createElement("div",{className:"webview-card",style:c},l)}});_exports=m}var _exports;init(),module.exports=_exports;