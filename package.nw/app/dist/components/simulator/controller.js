"use strict";function init(){var e=(require("fs"),require("../../lib/react.js")),t=require("../../lib/react-dom.js"),i=require("./toolbar/toolbar.js"),r=require("./webviewtab.js"),s=require("./share/webviewWeappShare.js"),a=require("querystring"),n=require("./webview.js"),o=require("../../weapp/utils/tools.js"),c=require("../../stores/webviewStores.js"),h=require("../../stores/windowStores.js"),l=require("../../actions/windowActions.js"),u=(require("../../actions/webviewActions.js"),require("../../stores/projectStores.js"),require("../../cssStr/cssStr.js")),p=(require("../../common/log/log.js"),require("../../common/request/request.js"),require("./actions/simulatorActions.js")),w=require("./webviewBackwardMask.js"),v=require("./payment/webviewpayment.js"),b=(require("../../utils/tools.js"),require("url")),d=(require("../../config/urlConfig.js"),require("../../weapp/utils/projectManager.js")),f=require("./webview/modal.js"),m=require("./webview/toast.js"),g=require("./webview/picker"),S=require("./webview/actionSheet.js"),E=require("./webview/authorizeDialog.js"),W=require("./webview/settingDialog.js"),I=require("./webview/confirm.js"),_=require("./webview/previewImage.js"),N=require("./webview/addCardView.js"),D=require("./webview/openCardView.js"),j=require("./grouplist/grouplist.js"),T=require("../../config/weappConfig.js"),A=T.default_scene,R=require("../../config/weappConfig.js"),O=R.default_android_tabbar_height,y=R.default_ios_tabbar_height,q=R.default_backgroundColor,B=require("./sdkimplement/index.js"),C=0,P=e.createClass({displayName:"Controller",getInitialState:function(){var e="app/html/about.html",t=0,i=0,r=0,s={},a={window:{}},n={},o={},c=h.getOffset(),u=!1,p=!1,w="",v="",b="",f="",m=this.props.project;if(m){try{if(e=d.getAppEntranceSync(m),a=d.getAppJSONSync(m),s=a.tabBar||{},m.initPath&&m.initPath.enable&&m.initPath.page)o=d.getPageJSONSync(m,m.initPath.page);else{var g=a.pages||[];o=d.getPageJSONSync(m,g[0])}}catch(t){e=""}var S=this.getTabPageIndex(e,s);u=S>-1&&this.getRouteName(s.list[S].pagePath),setTimeout(function(){l.changeUrl(e,t)})}var E=!1;return{currentWebviewID:t,topWebviewID:i,showCard:p,tabBar:s,appJSON:a,offset:c,cardInfo:n,showRecordWording:E,list:{0:{href:e,dataURI:w,preWebviewID:r,pageJSON:o,isTabbar:u,shareBtnState:{show:!1,isDynamic:!1,withShareTicket:!1},shareDataURI:void 0}},shareInfo:{show:!1,imgUrl:"",title:"",desc:""},uuid:v,qrcode:b,qrcodeState:f,scene:m&&m.initPath&&m.initPath.enable&&m.initPath.scene||A}},createWebviewId:function(){return++C},setAnimateImg:function(e,i){var r=document.createElement("div");if(i.dataURI){var s=document.createElement("img");r.appendChild(s),s.src=i.dataURI}r.className="simulator-animate-png";var a=t.findDOMNode(this.refs["webview"+this.state.currentWebviewID]),n=a.getBoundingClientRect(),o=n.top,c=n.left,h=n.height,l=n.width;e?r.style.cssText="background-color:"+i.color+";width:"+l+"px;height:"+h+"px;top:"+o+"px;left:"+c+"px;transform:translate3d("+l+"px,0,0)":r.style.cssText="margin-top:42px;width:"+l+"px;height:"+(h-42)+"px;top:"+o+"px;left:"+c+"px;transform:translate3d(0,0,0)",global.contentDocumentBody.appendChild(r);r.offsetTop;return r},getRouteName:function(e){return b.parse(e).pathname.split(".")[0].replace(/^\//,"")},postAppRoute:function(e,t,i,r){if(this.props.project){var s=b.parse(e),a=s.pathname.replace(/^\//,""),n=(s.query||"").split("&"),o={};n.forEach(function(e){var t=e.split("=");t[0]&&("appLaunch"==i?o[t[0]]=decodeURIComponent(t[1]):o[t[0]]=t[1])}),this.getSimulatorActions("S_POSTMSG_TO_AS",null,{eventName:r?"onAppRouteDone":"onAppRoute",type:"ON_APPLIFECYCLE_EVENT",data:{path:a||"index.html",query:o,openType:i},webviewID:parseInt(t)})}},goBack:function(e,i,r,s){var a=this;if(s=s||1,this.props.project||!i.canGoBack()||r){if(this.props.project){if(e===this.state.topWebviewID||1==Object.keys(this.state.list).length)return;var n=this.state.list[e];if(!n||n.isTabbar)return;for(var o,c=e,h=[];s--&&this.state.list[c]&&0!=c;)h.push(c),o=this.state.list[c],c=o.prevWebviewID;this.state.list[c]||(c=0);var l=t.findDOMNode(this.refs["webview"+e]),u=l.querySelector(".webviewbody"+e),p=t.findDOMNode(this.refs["webview"+c]),w=p.querySelector(".webviewbody"+c);n.isMap||this.postAppRoute(w.src,c,"navigateBack"),u.captureVisibleRegion(function(e){var t=a.setAnimateImg(!1,{dataURI:e}),i=u.offsetWidth,r=Object.assign({},a.state.list);for(var s in h)delete r[h[s]];a.setState({list:r,currentWebviewID:c},function(){t.addEventListener("transitionend",function(){global.contentDocumentBody.removeChild(t),a.postAppRoute(w.src,c,"navigateBack",!0);for(var e in h)a.getSimulatorActions("S_DELETE_WEBVIEW",null,{webviewID:h[e]});a.getSimulatorActions("S_CHANGE_CURRENT_WEBVIEW",null,{webviewID:c})}),t.style.transform="translate3d("+i+"px,0,0)"})})}}else i.back()},_getOpenWebviewNum:function(){var e=this.state.list,t=0,i=!1;for(var r in e)!i&&e[r].isTabbar&&(i=!0,t++),e[r].isTabbar||t++;return t},_openNewWebview:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},i=e.url,r=e.isMap,s=e.type,a=this.state.currentWebviewID;if(!e.isMap&&this._getOpenWebviewNum()>=5)return void t("webview count limit exceed");var n=this.state.appJSON,o={},c=q;if(!r){try{o=d.getPageJSONSync(this.props.project,i)}catch(e){}c=o.backgroundColor||n.window.backgroundColor||q}var h=this.setAnimateImg(!0,{color:c});C++;var l=Object.assign({},this.state.list);l[C]={prevWebviewID:a,href:i,pageJSON:o,isMap:r,type:s},this.setState({currentWebviewID:C,list:l}),this.getSimulatorActions("S_CHANGE_CURRENT_WEBVIEW",null,{webviewID:C}),h.style.transform="translate3d(0,0,0)",h.addEventListener("transitionend",function(){h.parentNode.removeChild(h),t(null,C)})},_openNewWindowWebview:function(e){var t=this,i=e.url,r=this.getRouteName(i),s={},a=this.props.project;try{s=d.getPageJSONSync(a,i)}catch(e){}var n=(s.backgroundColor||"#ffffff",o.getBaseURL(a));i=b.resolve(n,i+".html");var c=Object.assign({},this.state.list),h={},l={};for(var u in c){var p=c[u];p.isTabbar&&(p.isTabbar===r&&(l.currentWebviewID=parseInt(u)),h[u]=p)}l.list=h;var w=!1;void 0===l.currentWebviewID&&(l.currentWebviewID=++C,l.list[C]={showUrl:!1,hideBack:!0,isTabbar:r,href:i,pageJSON:s,type:"switchTab"},w=!0);var v=l.currentWebviewID,f=l.currentWebviewID!=this.state.currentWebviewID;return this.setState(l,function(){setTimeout(function(){!w&&f&&(t.postAppRoute(i,v,"switchTab"),t.postAppRoute(i,v,"switchTab",!0)),t.getSimulatorActions("S_CHANGE_CURRENT_WEBVIEW",null,{webviewID:v})},0)}),v},_changeWebviewID:function(e){this.setState({currentWebviewID:e})},_setWebviewInfo:function(e){var t=this.state.tabBar;t.list||[];e.height&&this.setState({offset:{height:e.height,width:e.width,dpr:e.dpr}})},_setWebviewSnapshot:function(e,t){var i=Object.assign({},this.state.list);i[e].dataURI=t,this.setState({list:i})},_postMessageToAllWebview:function(e){var t=this,i=e.webviewIds||[],r=0===i.length;setTimeout(function(){e.act="sendMsgFromAppService";var s=void 0;s=r?Object.keys(t.state.list):i,s.forEach(function(i){t.getSimulatorActions("S_SET_ACTION",i,e)})},17)},doSimulaterActions:function(e,i,r){var s=function(){"function"==typeof r&&r.apply(r,arguments)};switch(e){case"OPEN_NEW_WEBVIEW":this._openNewWebview(i,s);break;case"OPEN_NEW_WINDOW_WEBVIEW":this._openNewWindowWebview(i),s(null);break;case"WEBVIEW_BACK":var a=this.state.currentWebviewID,n=t.findDOMNode(this.refs["webview"+a]),o=n.querySelector(".webviewbody"+a);this.goBack(this.state.currentWebviewID,o,!1,i.delta);break;case"CAPTRUE_WEBVIEW":var c=this.state.currentWebviewID,h=t.findDOMNode(this.refs["webview"+c]),l=h.querySelector(".webviewbody"+c);l.captureVisibleRegion(function(e){s(null,e)})}},getWebviewList:function(){return Object.assign({},this.state.list)},onShareGroupSelect:function(e){var t=this.state.shareInfo;t.group=e,this.setState({shareInfo:t});var i=this.state.list[this.state.currentWebviewID],r=i.shareBtnState;this.getSimulatorActions("S_POSTMSG_TO_AS",null,{eventName:"onShareAppMessage",data:{dynamic:!!r.isDynamic,mode:r.withShareTicket?"withShareTicket":"common"},webviewID:this.state.currentWebviewID})},_upWebviewStatus:function(e,t){this.upCurrentWebviewURL(t.url)},_toggleRecordWording:function(e){this.setState({showRecordWording:e})},_onSumilatorNetworkChange:function(e){this.getSimulatorActions("S_POSTMSG_TO_AS",null,{eventName:"onNetworkStatusChange",data:{networkType:e,isConnected:"none"!=e},webviewID:parseInt(this.state.currentWebviewID)})},_onWebviewInterface:function(e,i,r,s){var a=this;if("initReady"===i){var n=t.findDOMNode(this.refs["webview"+e]),o=n.querySelector(".webviewbody"+e);setTimeout(function(){try{o.captureVisibleRegion(function(t){var i=Object.assign({},a.state.list);i[e]&&(i[e].shareDataURI=t,a.setState({list:i}))})}catch(e){}},200)}},getTabPageIndex:function(e,t){var i=o.getFileNameFromUrl(e,this.props.project).replace(/\.wxml$/,"");t=t||this.state.tabBar;var r=t.list||[],s=r.findIndex(function(e){return e.pagePath===i});return s},upCurrentWebviewURL:function(e){},getSimulatorActions:function(e,i,r){var s={currentWebviewID:this.state.currentWebviewID};if(p(e,i,r,s),"S_CHANGE_CURRENT_WEBVIEW"===e){var a=r.webviewID;if(a===this.state.currentWebviewID){var n=t.findDOMNode(this.refs["webview"+a]),o=n.querySelector("webview"),c=o.src;this.upCurrentWebviewURL(c),l.changeUrl(c,a)}}},projectHasTab:function(){var e=this.state.tabBar.list||[],t=e.length;return t&&e.length<=5&&e.length>=2},_onAppEnterForground:function(e){this.setState({scene:e.scene})},componentDidMount:function(){c.on("CHANGE_WEBVIEW_ID",this._changeWebviewID),h.on("SET_WEBVIEW_INFO",this._setWebviewInfo),c.on("AS_PUBLISH",this._postMessageToAllWebview),c.on("SET_WEBVIEW_SNAPSHOT",this._setWebviewSnapshot),c.on("UP_WEBVIEW_STATUS",this._upWebviewStatus),c.on("TOGGLE_RECORD_WORDING",this._toggleRecordWording),c.on("SET_INTERFACE_ASYNC_RES",this._onWebviewInterface),c.on("SIMULATOR_NETWORK_CHANGE",this._onSumilatorNetworkChange),h.on("APP_ENTER_FOREGROUND",this._onAppEnterForground);var e=this.props.project?1:12;chrome.fontSettings.setMinimumFontSize({pixelSize:e}),B.register(this)},componentWillUnmount:function(){c.removeListener("CHANGE_WEBVIEW_ID",this._changeWebviewID),h.removeListener("SET_WEBVIEW_INFO",this._setWebviewInfo),c.removeListener("AS_PUBLISH",this._postMessageToAllWebview),c.removeListener("SET_WEBVIEW_SNAPSHOT",this._setWebviewSnapshot),c.removeListener("UP_WEBVIEW_STATUS",this._upWebviewStatus),c.removeListener("TOGGLE_RECORD_WORDING",this._toggleRecordWording),c.removeListener("SET_INTERFACE_ASYNC_RES",this._onWebviewInterface),c.removeListener("SIMULATOR_NETWORK_CHANGE",this._onSumilatorNetworkChange),h.removeListener("APP_ENTER_FOREGROUND",this._onAppEnterForground),B.unregister(this)},chooseLocation:function(){},closeLocation:function(){},hideShare:function(){var e={show:!1};this.setState({shareInfo:e})},render:function(){var t=[];for(var o in this.state.list){var c=o==this.state.currentWebviewID?{}:u.webviewDisplayNone,l=this.state.list[o],p=this.getTabPageIndex(l.href),d=null,T=null,R=Object.assign({},this.state.offset);if(this.projectHasTab()&&p>-1){var q=this.state.tabBar.position,B={width:this.state.offset.width,margin:"0 auto"},C=e.createElement("div",{style:B},e.createElement(r,{webviewID:o,tabPageIndex:p,project:this.props.project,_openNewWindowWebview:this._openNewWindowWebview,tabBar:this.state.tabBar}));"top"===q?d=C:T=C;var P=h.getWebviewInfo,k=void 0;k="iOS"===P.os?y:O,R.height=R.height-k}t.push(e.createElement("div",{key:o,style:c},e.createElement("div",{className:"simulator-shadow",style:{width:R.width}},e.createElement(n,{showRecordWording:this.state.showRecordWording,type:l.type,ref:"webview"+o,webviewID:o,project:this.props.project,offset:R,isTabWebview:p>-1,href:l.href,pageJSON:l.pageJSON,appJSON:this.state.appJSON,isMap:l.isMap,chooseLocation:this.chooseLocation,closeLocation:this.closeLocation,hideBack:!!l.hideBack,goBack:this.goBack,getSimulatorActions:this.getSimulatorActions,postAppRoute:this.postAppRoute,topTabDom:d,shareBtnState:l.shareBtnState}),T)))}var U=this.props.project?e.createElement(s,{shareInfo:this.state.shareInfo,hideShare:this.hideShare}):null,L=!!this.props.project,x=u.displayNone,M=void 0,V=void 0,G=u.displayNone,F=void 0;if(L){var H=this.state.list[this.state.currentWebviewID];if(H.href){var J=b.parse(H.href);x={},M=J.pathname.replace(".html","").replace(/^\//,"");var z=a.parse(J.query||""),K=[];for(var Y in z)K.push(Y+"="+z[Y]);V=K.join("&")}V&&(G={}),F=this.state.scene||A}return e.createElement("div",{className:"simulator-wrapper"},e.createElement(i,{getSimulatorActions:this.getSimulatorActions,list:this.state.list,currentWebviewID:this.state.currentWebviewID,project:this.props.project,show:this.props.show}),e.createElement("div",{className:"simulator-list-wrapper",style:{width:this.state.offset.width}},U,t,e.createElement(N,{project:this.props.project}),e.createElement(D,{project:this.props.project}),e.createElement(S,{webviewID:this.state.currentWebviewID}),e.createElement(m,{project:this.props.project,webviewID:this.state.currentWebviewID}),e.createElement(f,{webviewID:this.state.currentWebviewID}),e.createElement(I,{webviewID:this.state.currentWebviewID}),e.createElement(g,{webviewID:this.state.currentWebviewID}),e.createElement(_,{width:this.state.offset.width,project:this.props.project}),e.createElement(v,null),e.createElement(E,null),e.createElement(W,{project:this.props.project}),e.createElement(j,{shareBtnState:this.state.list[this.state.currentWebviewID].shareBtnState,onSelect:this.onShareGroupSelect})),e.createElement(w,null),e.createElement("div",{className:"simulator-status-bar",style:x},e.createElement("p",{className:"simulator-status-bar-item"},e.createElement("label",null,"场景值："),e.createElement("span",{title:F},F)),e.createElement("p",{className:"simulator-status-bar-item"},e.createElement("label",null,"页面路径："),e.createElement("span",{title:M},M)),e.createElement("p",{style:G,className:"simulator-status-bar-item"},e.createElement("label",null,"页面参数："),e.createElement("span",{title:V},V))))}});_exports=P}var _exports;init(),module.exports=_exports;